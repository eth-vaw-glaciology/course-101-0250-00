<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <script src="/libs/lunr/lunr.min.js"></script> <script src="/libs/lunr/lunr_index.js"></script> <script src="/libs/lunr/lunrclient.min.js"></script> <link rel=stylesheet  href="/libs/katex/katex.min.css"> <link rel=stylesheet  href="/libs/highlight/github.min.css"> <link rel=stylesheet  href="/css/franklin.css"> <link rel=stylesheet  href="/css/poole_hyde.css"> <link rel=stylesheet  href="/css/custom.css"> <style> html {font-size: 17px;} .franklin-content {position: relative; padding-left: 8%; padding-right: 5%; line-height: 1.35em;} @media (min-width: 940px) { .franklin-content {width: 100%; margin-left: auto; margin-right: auto;} } @media (max-width: 768px) { .franklin-content {padding-left: 6%; padding-right: 6%;} } </style> <link rel=icon  href="/assets/favicon.png"> <title>Lecture 6</title> <style> .content {max-width: 50rem} </style> <div class=sidebar > <div class="container sidebar-sticky"> <div class=sidebar-about > <img src="/assets/vaw_logo.png" style="width: 180px; height: auto; display: inline"> <div style="margin-bottom: 0.5em"><a href="/"> Fall 2025</a> <span style="opacity: 0.7;">| <a href=https://www.vorlesungen.ethz.ch/Vorlesungsverzeichnis/lerneinheit.view?semkez=2025W&ansicht=KATALOGDATEN&lerneinheitId=193496&lang=en> ETHZ 101-0250-00</a></span></div> <br> <h1><a href="/">Solving partial differential equations in parallel on GPUs I</a></h1> <div style="line-height:18px; font-size: 15px; opacity: 0.85">by &nbsp; <a href="https://vaw.ethz.ch/en/people/person-detail.MjcwOTYw.TGlzdC8xOTYxLDE1MTczNjI1ODA=.html">Ludovic Räss</a>, &nbsp; <a href="https://vaw.ethz.ch/en/personen/person-detail.html?persid=124402">Mauro Werder</a>, &nbsp; <a href="https://www.cscs.ch/about/staff/">Samuel Omlin</a> & <br> <a href="https://vaw.ethz.ch/en/people/person-detail.MzAwMjIy.TGlzdC8xOTYxLDE1MTczNjI1ODA=.html">Ivan Utkin</a> </div> </div> <br> <style> </style> <nav class=sidebar-nav  style="opacity: 0.9; margin-bottom: 1cm;"> <a class="sidebar-nav-item " href="/"><b>Welcome</b></a> <a class="sidebar-nav-item " href="/logistics/">Logistics</a> <a class="sidebar-nav-item " href="/homework/">Homeworks</a> <a class="sidebar-nav-item " href="/software_install/">Software install</a> <a class="sidebar-nav-item " href="/extras/">Extras</a> <br> <div class=course-section >Part 1 – Introduction</div> <a class="sidebar-nav-item " href="/lecture1/">Lecture 1 – Introduction to Julia</a> <a class="sidebar-nav-item " href="/lecture2/">Lecture 2 – PDEs & physical processes</a> <a class="sidebar-nav-item " href="/lecture3/"> Lecture 3 – Solving elliptic PDEs</a> <a class="sidebar-nav-item " href="/lecture4/">Lecture 4 – Coupled multi-physics</a> <div class=course-section >Part 2 – Solving PDEs on GPUs</div> <a class="sidebar-nav-item " href="/lecture5/">Lecture 5 – Porous convection</a> <a class="sidebar-nav-item active" href="/lecture6/">Lecture 6 – Parallel computing</a> <a class="sidebar-nav-item " href="/lecture7/">Lecture 7 – GPU computing I</a> <div class="sidebar-nav-item under-construction"> Lecture 8 – GPU computing II</div> <div class=course-section >Part 3 – Multi-GPU computing (projects)</div> <!-- <a class="sidebar-nav-item {{ispage lecture9/*}}active{{end}}" href="/lecture9/">Lecture 9 – xPU computing</a> <a class="sidebar-nav-item {{ispage lecture10/*}}active{{end}}" href="/lecture10/">Lecture 10 – Julia MPI & multi-xPU</a> <a class="sidebar-nav-item {{ispage lecture11/*}}active{{end}}" href="/lecture11/">Lecture 11 – Multi-xPU & Projects</a> <a class="sidebar-nav-item {{ispage lecture12/*}}active{{end}}" href="/lecture12/">Lecture 12 – Advanced optimisations</a> --> <div class="sidebar-nav-item under-construction"> Lecture 9 – xPU computing</div> <div class="sidebar-nav-item under-construction"> Lecture 10 – Julia MPI & multi-xPU</div> <div class="sidebar-nav-item under-construction"> Lecture 11 – Multi-xPU & Projects</div> <div class="sidebar-nav-item under-construction"> Lecture 12 – Advanced optimisations</div> </nav> <form id=lunrSearchForm  name=lunrSearchForm > <input class=search-input  name=q  placeholder="Enter search term" type=text > <input type=submit  value=Search  formaction="/search/index.html"> </form> <br> <br> </div> </div> <div class="content container"> <div class=franklin-content > <h1 id=lecture_6 ><a href="#lecture_6" class=header-anchor >Lecture 6</a></h1> <blockquote> <p><strong>Agenda</strong><br />📚 Parallel computing on CPUs &amp; performance assessment, the <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{eff}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> metric<br />💻 Unit testing in Julia<br />🚧 Exercises:</p> <ul> <li><p>CPU perf. codes for 2D diffusion and memcopy</p> <li><p>Unit tests and testset implementation</p> </ul> </blockquote> <p><hr /> </p> <p><a id=content  class=anchor ></a> <strong>Content</strong></p> <div class=franklin-toc ><ol><li><a href="#lecture_6">Lecture 6</a><li><a href="#parallel_computing_on_cpus_and_performance_assessment">Parallel computing &#40;on CPUs&#41; and performance assessment</a><ol><li><a href="#performance">Performance</a><li><a href="#performance_limiters">Performance limiters</a><li><a href="#effective_memory_throughput_metric_t_mathrmeff">Effective memory throughput metric <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{eff}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></a><li><a href="#parallel_computing_on_cpus">Parallel computing on CPUs</a><li><a href="#shared_memory_parallelisation">Shared memory parallelisation</a></ol><li><a href="#unit_testing_in_julia">Unit testing in Julia</a><ol><li><a href="#basic_unit_tests">Basic unit tests</a><li><a href="#working_with_a_test_sets">Working with a test sets</a></ol><li><a href="#exercises_-_lecture_6">Exercises - lecture 6</a><ol><li><a href="#exercise_1_performance_implementation">Exercise 1 — <strong>Performance implementation</strong></a><li><a href="#exercise_2_performance_evaluation">Exercise 2 — <strong>Performance evaluation</strong></a><li><a href="#exercise_3_unit_tests">Exercise 3 — <strong>Unit tests</strong></a></ol></ol></div> <p><a href="#exercises_-_lecture_6"><em>👉 get started with exercises</em></a></p> <hr /> <h1 id=parallel_computing_on_cpus_and_performance_assessment ><a href="#parallel_computing_on_cpus_and_performance_assessment" class=header-anchor >Parallel computing &#40;on CPUs&#41; and performance assessment</a></h1> <h2 id=performance ><a href="#performance" class=header-anchor >Performance</a></h2> <h3 id=some_questions_for_you ><a href="#some_questions_for_you" class=header-anchor >❓ some questions for you:</a></h3> <ul> <li><p>How to assess the performance of numerical application?</p> <li><p>Are you familiar the concept of wall-time?</p> <li><p>What are the key ingredients to understand performance?</p> </ul> <h3 id=the_goal_of_this_lecture_6_is_to_introduce ><a href="#the_goal_of_this_lecture_6_is_to_introduce" class=header-anchor >The goal of this lecture 6 is to introduce:</a></h3> <ul> <li><p>Performance limiters</p> <li><p>Effective memory throughput metric <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{eff}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></p> <li><p>Parallel computing on CPUs</p> <li><p>Shared memory parallelisation</p> </ul> <h2 id=performance_limiters ><a href="#performance_limiters" class=header-anchor >Performance limiters</a></h2> <h3 id=hardware ><a href="#hardware" class=header-anchor >Hardware</a></h3> <ul> <li><p>Recent processors &#40;CPUs and GPUs&#41; have multiple &#40;or many&#41; cores</p> <li><p>Recent processors use their parallelism to hide latency &#40;i.e. overlapping execution times &#40;latencies&#41; of individual operations with execution times of other operations&#41;</p> <li><p>Multi-core CPUs and GPUs share similar challenges</p> </ul> <p><em>Recall from lecture 1 &#40;<strong>why we do it</strong>&#41; ...</em></p> <p>Use <strong>parallel computing</strong> &#40;to address this&#41;:</p> <ul> <li><p>The &quot;memory wall&quot; in ~ 2004</p> <li><p>Single-core to multi-core devices</p> </ul> <p><img src="../assets/literate_figures/l1_mem_wall.png" alt=mem_wall  /></p> <p>GPUs are massively parallel devices</p> <ul> <li><p>SIMD machine &#40;programmed using threads - SPMD&#41; &#40;<a href="https://safari.ethz.ch/architecture/fall2020/lib/exe/fetch.php?media&#61;onur-comparch-fall2020-lecture24-simdandgpu-afterlecture.pdf">more</a>&#41;</p> <li><p>Further increases the FLOPS vs Bytes gap</p> </ul> <p><img src="../assets/literate_figures/l1_cpu_gpu_evo.png" alt=cpu_gpu_evo  /></p> <p>Taking a look at a recent GPU and CPU:</p> <ul> <li><p>Nvidia A100 GPU</p> <li><p>Nvidia GH200 GPU</p> <li><p>AMD EPYC &quot;Rome&quot; 7282 &#40;16 cores&#41; CPU</p> </ul> <table><tr><th align=center >Device<th align=center >TFLOP/s &#40;FP64&#41;<th align=center >Memory BW TB/s<tr><td align=center >Nvidia GH200<td align=center >34<td align=center >4<tr><td align=center >Nvidia A100<td align=center >9.7<td align=center >1.55<tr><td align=center >AMD EPYC 7282<td align=center >0.7<td align=center >0.085</table> <p>Current GPUs &#40;and CPUs&#41; can do many more computations in a given amount of time than they can access numbers from main memory.</p> <p>Quantify the imbalance:</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mfrac><mrow><mi mathvariant=normal >c</mi><mi mathvariant=normal >o</mi><mi mathvariant=normal >m</mi><mi mathvariant=normal >p</mi><mi mathvariant=normal >u</mi><mi mathvariant=normal >t</mi><mi mathvariant=normal >a</mi><mi mathvariant=normal >t</mi><mi mathvariant=normal >i</mi><mi mathvariant=normal >o</mi><mi mathvariant=normal >n</mi><mtext> </mtext><mi mathvariant=normal >p</mi><mi mathvariant=normal >e</mi><mi mathvariant=normal >a</mi><mi mathvariant=normal >k</mi><mtext> </mtext><mi mathvariant=normal >p</mi><mi mathvariant=normal >e</mi><mi mathvariant=normal >r</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >o</mi><mi mathvariant=normal >r</mi><mi mathvariant=normal >m</mi><mi mathvariant=normal >a</mi><mi mathvariant=normal >n</mi><mi mathvariant=normal >c</mi><mi mathvariant=normal >e</mi><mtext> </mtext><mo stretchy=false >[</mo><mi mathvariant=normal >T</mi><mi mathvariant=normal >F</mi><mi mathvariant=normal >L</mi><mi mathvariant=normal >O</mi><mi mathvariant=normal >P</mi><mi mathvariant=normal >/</mi><mi mathvariant=normal >s</mi><mo stretchy=false >]</mo></mrow><mrow><mi mathvariant=normal >m</mi><mi mathvariant=normal >e</mi><mi mathvariant=normal >m</mi><mi mathvariant=normal >o</mi><mi mathvariant=normal >r</mi><mi mathvariant=normal >y</mi><mtext> </mtext><mi mathvariant=normal >a</mi><mi mathvariant=normal >c</mi><mi mathvariant=normal >c</mi><mi mathvariant=normal >e</mi><mi mathvariant=normal >s</mi><mi mathvariant=normal >s</mi><mtext> </mtext><mi mathvariant=normal >p</mi><mi mathvariant=normal >e</mi><mi mathvariant=normal >a</mi><mi mathvariant=normal >k</mi><mtext> </mtext><mi mathvariant=normal >p</mi><mi mathvariant=normal >e</mi><mi mathvariant=normal >r</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >o</mi><mi mathvariant=normal >r</mi><mi mathvariant=normal >m</mi><mi mathvariant=normal >a</mi><mi mathvariant=normal >n</mi><mi mathvariant=normal >c</mi><mi mathvariant=normal >e</mi><mtext> </mtext><mo stretchy=false >[</mo><mi mathvariant=normal >T</mi><mi mathvariant=normal >B</mi><mi mathvariant=normal >/</mi><mi mathvariant=normal >s</mi><mo stretchy=false >]</mo></mrow></mfrac><mo>×</mo><mrow><mi mathvariant=normal >s</mi><mi mathvariant=normal >i</mi><mi mathvariant=normal >z</mi><mi mathvariant=normal >e</mi><mtext> </mtext><mi mathvariant=normal >o</mi><mi mathvariant=normal >f</mi><mtext> </mtext><mi mathvariant=normal >a</mi><mtext> </mtext><mi mathvariant=normal >n</mi><mi mathvariant=normal >u</mi><mi mathvariant=normal >m</mi><mi mathvariant=normal >b</mi><mi mathvariant=normal >e</mi><mi mathvariant=normal >r</mi><mtext> </mtext><mo stretchy=false >[</mo><mi mathvariant=normal >B</mi><mi mathvariant=normal >y</mi><mi mathvariant=normal >t</mi><mi mathvariant=normal >e</mi><mi mathvariant=normal >s</mi><mo stretchy=false >]</mo></mrow></mrow><annotation encoding="application/x-tex"> \frac{\mathrm{computation\;peak\;performance\;[TFLOP/s]}}{\mathrm{memory\;access\;peak\;performance\;[TB/s]}} × \mathrm{size\;of\;a\;number\;[Bytes]} </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:2.363em;vertical-align:-0.936em;"></span><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.427em;"><span style="top:-2.314em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class="mord mathrm">m</span><span class="mord mathrm">e</span><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">r</span><span class="mord mathrm" style="margin-right:0.01389em;">y</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm">a</span><span class="mord mathrm">c</span><span class="mord mathrm">c</span><span class="mord mathrm">e</span><span class="mord mathrm">s</span><span class="mord mathrm">s</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm">p</span><span class="mord mathrm">e</span><span class="mord mathrm">a</span><span class="mord mathrm">k</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm">p</span><span class="mord mathrm">e</span><span class="mord mathrm">r</span><span class="mord mathrm" style="margin-right:0.07778em;">f</span><span class="mord mathrm">o</span><span class="mord mathrm">r</span><span class="mord mathrm">m</span><span class="mord mathrm">a</span><span class="mord mathrm">n</span><span class="mord mathrm">c</span><span class="mord mathrm">e</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mopen >[</span><span class="mord mathrm">T</span><span class="mord mathrm">B</span><span class="mord mathrm">/</span><span class="mord mathrm">s</span><span class=mclose >]</span></span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class="mord mathrm">c</span><span class="mord mathrm">o</span><span class="mord mathrm">m</span><span class="mord mathrm">p</span><span class="mord mathrm">u</span><span class="mord mathrm">t</span><span class="mord mathrm">a</span><span class="mord mathrm">t</span><span class="mord mathrm">i</span><span class="mord mathrm">o</span><span class="mord mathrm">n</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm">p</span><span class="mord mathrm">e</span><span class="mord mathrm">a</span><span class="mord mathrm">k</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm">p</span><span class="mord mathrm">e</span><span class="mord mathrm">r</span><span class="mord mathrm" style="margin-right:0.07778em;">f</span><span class="mord mathrm">o</span><span class="mord mathrm">r</span><span class="mord mathrm">m</span><span class="mord mathrm">a</span><span class="mord mathrm">n</span><span class="mord mathrm">c</span><span class="mord mathrm">e</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mopen >[</span><span class="mord mathrm">T</span><span class="mord mathrm">F</span><span class="mord mathrm">L</span><span class="mord mathrm">O</span><span class="mord mathrm">P</span><span class="mord mathrm">/</span><span class="mord mathrm">s</span><span class=mclose >]</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >×</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathrm">s</span><span class="mord mathrm">i</span><span class="mord mathrm">z</span><span class="mord mathrm">e</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm">o</span><span class="mord mathrm" style="margin-right:0.07778em;">f</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm">a</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathrm">n</span><span class="mord mathrm">u</span><span class="mord mathrm">m</span><span class="mord mathrm">b</span><span class="mord mathrm">e</span><span class="mord mathrm">r</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mopen >[</span><span class="mord mathrm">B</span><span class="mord mathrm" style="margin-right:0.01389em;">y</span><span class="mord mathrm">t</span><span class="mord mathrm">e</span><span class="mord mathrm">s</span><span class=mclose >]</span></span></span></span></span></span> <p><em>&#40;Theoretical peak performance values as specified by the vendors can be used&#41;.</em></p> <p>Back to our hardware:</p> <table><tr><th align=center >Device<th align=center >TFLOP/s &#40;FP64&#41;<th align=center >Memory BW TB/s<th align=center >Imbalance &#40;FP64&#41;<tr><td align=center >Nvidia GH200<td align=center >34<td align=center >4<td align=center >34 / 4 × 8 &#61; 68<tr><td align=center >Nvidia A100<td align=center >9.7<td align=center >1.55<td align=center >9.7 / 1.55 × 8 &#61; 50<tr><td align=center >AMD EPYC 7282<td align=center >0.7<td align=center >0.085<td align=center >0.7 / 0.085 × 8 &#61; 66</table> <p><em>&#40;here computed with double precision values&#41;</em></p> <p><strong>Meaning:</strong> we can do ≥ 50 &#40;GPU&#41; and 66 &#40;CPU&#41; floating point operations per number accessed from main memory. Floating point operations are &quot;for free&quot; when we work in memory-bounded regimes</p> <p>➡ Requires to re-think the numerical implementation and solution strategies</p> <h3 id=on_the_scientific_application_side ><a href="#on_the_scientific_application_side" class=header-anchor >On the scientific application side</a></h3> <ul> <li><p>Most algorithms require only a few operations or FLOPS ...</p> <li><p>... compared to the amount of numbers or bytes accessed from main memory.</p> </ul> <p>First derivative example <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=normal >∂</mi><mi>A</mi><mi mathvariant=normal >/</mi><mi mathvariant=normal >∂</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">∂A / ∂x</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord  style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">A</span><span class=mord >/</span><span class=mord  style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">x</span></span></span></span>:</p> <p>If we &quot;naively&quot; compare the &quot;cost&quot; of an isolated evaluation of a finite-difference first derivative, e.g., computing a flux <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span></span></span></span>:</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mi>q</mi><mo>=</mo><mo>−</mo><mi>D</mi><mtext> </mtext><mfrac><mrow><mi mathvariant=normal >∂</mi><mi>A</mi></mrow><mrow><mi mathvariant=normal >∂</mi><mi>x</mi></mrow></mfrac><mtext> </mtext><mo separator=true >,</mo></mrow><annotation encoding="application/x-tex">q = -D~\frac{∂A}{∂x}~,</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:2.05744em;vertical-align:-0.686em;"></span><span class=mord >−</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mspace nobreak"> </span><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.37144em;"><span style="top:-2.314em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord  style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">x</span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord  style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">A</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace nobreak"> </span><span class=mpunct >,</span></span></span></span></span> <p>which in the discrete form reads <code>q&#91;ix&#93; &#61; -D*&#40;A&#91;ix&#43;1&#93;-A&#91;ix&#93;&#41;/dx</code>.</p> <p>The cost of evaluating <code>q&#91;ix&#93; &#61; -D*&#40;A&#91;ix&#43;1&#93;-A&#91;ix&#93;&#41;/dx</code>:</p> <p>1 reads &#43; 1 write &#61;&gt; <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo>×</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">2 × 8</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.72777em;vertical-align:-0.08333em;"></span><span class=mord >2</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >×</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >8</span></span></span></span> &#61; <strong>16 Bytes transferred</strong></p> <p>1 &#40;fused&#41; addition and division &#61;&gt; <strong>1 floating point operation</strong></p> <p>assuming:</p> <ul> <li><p><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span></span>, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=normal >∂</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">∂x</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.69444em;vertical-align:0em;"></span><span class=mord  style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">x</span></span></span></span> are scalars</p> <li><p><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">A</span></span></span></span> are arrays of <code>Float64</code> &#40;read from main memory&#41;</p> </ul> <p>GPUs and CPUs perform 50 - 60 floating-point operations per number accessed from main memory</p> <p>First derivative evaluation requires to transfer 2 numbers per floating-point operations</p> <p>The FLOPS metric is no longer the most adequate for reporting the application performance of many modern applications on modern hardware.</p> <h2 id=effective_memory_throughput_metric_t_mathrmeff ><a href="#effective_memory_throughput_metric_t_mathrmeff" class=header-anchor >Effective memory throughput metric <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{eff}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></a></h2> <p>Need for a memory throughput-based performance evaluation metric: <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{eff}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> &#91;GB/s&#93;</p> <p>➡ Evaluate the performance of iterative stencil-based solvers.</p> <p>The effective memory access <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub></mrow><annotation encoding="application/x-tex">A_\mathrm{eff}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal">A</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> &#91;GB&#93;</p> <p>Sum of:</p> <ul> <li><p>twice the memory footprint of the unknown fields, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mi mathvariant=normal >u</mi></msub></mrow><annotation encoding="application/x-tex">D_\mathrm{u}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">u</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, &#40;fields that depend on their own history and that need to be updated every iteration&#41;</p> <li><p>known fields, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mi mathvariant=normal >k</mi></msub></mrow><annotation encoding="application/x-tex">D_\mathrm{k}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">k</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, that do not change every iteration.</p> </ul> <p>The effective memory access divided by the execution time per iteration, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mrow><mi mathvariant=normal >i</mi><mi mathvariant=normal >t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">t_\mathrm{it}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.76508em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal">t</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.31750199999999995em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">i</span><span class="mord mathrm mtight">t</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> &#91;sec&#93;, defines the effective memory throughput, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{eff}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> &#91;GB/s&#93;:</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><msub><mi>A</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub><mo>=</mo><mn>2</mn><mtext> </mtext><msub><mi>D</mi><mi mathvariant=normal >u</mi></msub><mo>+</mo><msub><mi>D</mi><mi mathvariant=normal >k</mi></msub></mrow><annotation encoding="application/x-tex"> A_\mathrm{eff} = 2~D_\mathrm{u} + D_\mathrm{k} </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal">A</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord >2</span><span class="mspace nobreak"> </span><span class=mord ><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">u</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">k</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub><mo>=</mo><mfrac><msub><mi>A</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub><msub><mi>t</mi><mrow><mi mathvariant=normal >i</mi><mi mathvariant=normal >t</mi></mrow></msub></mfrac></mrow><annotation encoding="application/x-tex"> T_\mathrm{eff} = \frac{A_\mathrm{eff}}{t_\mathrm{it}} </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:2.19633em;vertical-align:-0.8360000000000001em;"></span><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.36033em;"><span style="top:-2.3139999999999996em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class="mord mathnormal">t</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.31750199999999995em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">i</span><span class="mord mathrm mtight">t</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class="mord mathnormal">A</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.8360000000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span> <p>The upper bound of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{eff}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >p</mi><mi mathvariant=normal >e</mi><mi mathvariant=normal >a</mi><mi mathvariant=normal >k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{peak}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.969438em;vertical-align:-0.286108em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">p</span><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight">a</span><span class="mord mathrm mtight">k</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> as measured, e.g., by <a href="https://www.researchgate.net/publication/51992086_Memory_bandwidth_and_machine_balance_in_high_performance_computers">McCalpin, 1995</a> for CPUs or a GPU analogue.</p> <p>Defining the <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{eff}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> metric, we assume that:</p> <ol> <li><p>we evaluate an iterative stencil-based solver,</p> <li><p>the problem size is much larger than the cache sizes and</p> <li><p>the usage of time blocking is not feasible or advantageous &#40;reasonable for real-world applications&#41;.</p> </ol> <div class=note ><div class=title >💡 Note</div> <div class=messg >Fields within the effective memory access that do not depend on their own history; such fields can be re-computed on the fly or stored on-chip.</div></div> <p>As first task, we&#39;ll compute the <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{eff}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> for the 2D fluid pressure &#40;diffusion&#41; solver at the core of the porous convection algorithm from previous lecture.</p> <p>👉 Download the script <a href="https://github.com/eth-vaw-glaciology/course-101-0250-00/blob/main/scripts/"><code>l6_Pf_diffusion_2D.jl</code></a> to get started.</p> <p><strong>To-do list:</strong></p> <ul> <li><p>copy <a href="https://github.com/eth-vaw-glaciology/course-101-0250-00/blob/main/scripts/"><code>l6_Pf_diffusion_2D.jl</code></a>, rename it to <code>Pf_diffusion_2D_Teff.jl</code></p> <li><p>add a timer</p> <li><p>include the performance metric formulas</p> <li><p>deactivate visualisation</p> </ul> <p>💻 Let&#39;s get started</p> <h3 id=timer_and_performance ><a href="#timer_and_performance" class=header-anchor >Timer and performance</a></h3> <ul> <li><p>Use <code>Base.time&#40;&#41;</code> to return the current timestamp</p> <li><p>Define <code>t_tic</code>, the starting time, after 11 iterations steps to allow for &quot;warm-up&quot;</p> <li><p>Record the exact number of iterations &#40;introduce e.g. <code>niter</code>&#41;</p> <li><p>Compute the elapsed time <code>t_toc</code> at the end of the time loop and report:</p> </ul> <pre><code class="julia hljs">t_toc = ...
A_eff = ...          <span class=hljs-comment ># Effective main memory access per iteration [GB]</span>
t_it  = ...          <span class=hljs-comment ># Execution time per iteration [s]</span>
T_eff = A_eff/t_it   <span class=hljs-comment ># Effective memory throughput [GB/s]</span></code></pre> <ul> <li><p>Report <code>t_toc</code>, <code>T_eff</code> and <code>niter</code> at the end of the code, formatting output using <code>@printf&#40;&#41;</code> macro.</p> <li><p>Round <code>T_eff</code> to the 3rd significant digit.</p> </ul> <pre><code class="julia hljs"><span class=hljs-meta >@printf</span>(<span class=hljs-string >&quot;Time = %1.3f sec, ... \n&quot;</span>, t_toc, ...)</code></pre>
<h3 id=deactivate_visualisation_and_error_checking ><a href="#deactivate_visualisation_and_error_checking" class=header-anchor >Deactivate visualisation &#40;and error checking&#41;</a></h3>
<ul>
<li><p>Use keyword arguments &#40;&quot;kwargs&quot;&#41; to allow for default behaviour</p>

<li><p>Define a <code>do_check</code> flag set to <code>false</code></p>

</ul>
<pre><code class="julia hljs"><span class=hljs-keyword >function</span> Pf_diffusion_2D(;??)
    ...
    <span class=hljs-keyword >return</span>
<span class=hljs-keyword >end</span></code></pre>
<p>So far so good, we have now a timer.</p>
<p>Let&#39;s also boost resolution to <code>nx &#61; ny &#61; 511</code> and set <code>maxiter &#61; max&#40;nx,ny&#41;</code> to have the code running ~1 sec.</p>
<p>In the next part, we&#39;ll work on a multi-threading implementation.</p>
<h2 id=parallel_computing_on_cpus ><a href="#parallel_computing_on_cpus" class=header-anchor >Parallel computing on CPUs</a></h2>
<p><em>Towards implementing shared memory parallelisation using multi-threading capabilities of modern multi-core CPUs.</em></p>
<p>We&#39;ll work it out in 3 steps:</p>
<ol>
<li><p>Precomputing scalars, removing divisions &#40;and non-necessary arrays&#41;</p>

<li><p>Back to loops I</p>

<li><p>Back to loops II - compute functions &#40;future &quot;kernels&quot;&#41;</p>

</ol>
<h3 id=precomputing_scalars_removing_divisions_and_casual_arrays ><a href="#precomputing_scalars_removing_divisions_and_casual_arrays" class=header-anchor ><ol>
<li><p>Precomputing scalars, removing divisions and casual arrays</p>

</ol>
</a></h3>
<p>Let&#39;s duplicate <code>Pf_diffusion_2D_Teff.jl</code> and rename it as <code>Pf_diffusion_2D_perf.jl</code>.</p>
<ul>
<li><p>First, replace <code>k_ηf/dx</code> and <code>k_ηf/dy</code> in the flux calculations by inverse multiplications, such that</p>

</ul>
<pre><code class="julia hljs">k_ηf_dx, k_ηf_dy = k_ηf/dx, k_ηf/dy</code></pre>
<ul>
<li><p>Then, replace divisions <code>./&#40;1.0 &#43; θ_dτ&#41;</code> by inverse multiplications <code>*_1_θ_dτ</code> such that</p>

</ul>
<pre><code class="julia hljs">_1_θ_dτ = <span class=hljs-number >1.0</span>./(<span class=hljs-number >1.0</span> + θ_dτ)</code></pre>
<ul>
<li><p>Then, replace <code>./dx</code> and <code>./dy</code> in the <code>Pf</code> update by inverse multiplications <code>*_dx, *_dy</code> where</p>

</ul>
<pre><code class="julia hljs">_dx, _dy = <span class=hljs-number >1.0</span>/dx, <span class=hljs-number >1.0</span>/dy</code></pre>
<ul>
<li><p>Finally, also apply the same treatment to <code>./β_dτ</code></p>

</ul>
<h3 id=ol_start2_back_to_loops_i ><a href="#ol_start2_back_to_loops_i" class=header-anchor ><ol start=2 >
<li><p>Back to loops I</p>

</ol>
</a></h3>
<p>As first, duplicate <code>Pf_diffusion_2D_perf.jl</code> and rename it as <code>Pf_diffusion_2D_perf_loop.jl</code>.</p>
<p>The goal is now to write out the diffusion physics in a loop fashion over <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span> dimensions.</p>
<p>Implement a nested loop, taking car of bounds and staggering.</p>
<pre><code class="julia hljs"><span class=hljs-keyword >for</span> iy=??
    <span class=hljs-keyword >for</span> ix=??
        qDx[??] -= (qDx[??] + k_ηf_dx* ?? )*_1_θ_dτ
    <span class=hljs-keyword >end</span>
<span class=hljs-keyword >end</span>
<span class=hljs-keyword >for</span> iy=??
    <span class=hljs-keyword >for</span> ix=??
        qDy[??] -= (qDy[??] + k_ηf_dy* ?? )*_1_θ_dτ
    <span class=hljs-keyword >end</span>
<span class=hljs-keyword >end</span>
<span class=hljs-keyword >for</span> iy=??
    <span class=hljs-keyword >for</span> ix=??
        Pf[??]  -= ??
    <span class=hljs-keyword >end</span>
<span class=hljs-keyword >end</span></code></pre>
<p>We could now use macros to make the code nicer and clearer. Macro expression will be replaced during pre-processing &#40;prior to compilation&#41;. Also, macro can take arguments by appending <code>&#36;</code> in their definition.</p>
<p>Let&#39;s use macros to replace the derivative implementations</p>
<pre><code class="julia hljs"><span class=hljs-keyword >macro</span> d_xa(A)  esc(:( $A[??]-$A[??] )) <span class=hljs-keyword >end</span>
<span class=hljs-keyword >macro</span> d_ya(A)  esc(:( $A[??]-$A[??] )) <span class=hljs-keyword >end</span></code></pre>
<p>And update the code within the iteration loop:</p>
<pre><code class="julia hljs"><span class=hljs-keyword >for</span> iy=??
    <span class=hljs-keyword >for</span> ix=??
        qDx[??] -= (qDx[??] + k_ηf_dx* ?? )*_1_θ_dτ
    <span class=hljs-keyword >end</span>
<span class=hljs-keyword >end</span>
<span class=hljs-keyword >for</span> iy=??
    <span class=hljs-keyword >for</span> ix=??
        qDy[??] -= (qDy[??] + k_ηf_dy* ?? )*_1_θ_dτ
    <span class=hljs-keyword >end</span>
<span class=hljs-keyword >end</span>
<span class=hljs-keyword >for</span> iy=??
    <span class=hljs-keyword >for</span> ix=??
        Pf[??]  -= ??
    <span class=hljs-keyword >end</span>
<span class=hljs-keyword >end</span></code></pre>
<p>Performance is already quite better with the loop version 🚀.</p>
<p>Reasons are that <code>diff&#40;&#41;</code> are allocating and that Julia is overall well optimised for executing loops.</p>
<p>Let&#39;s now implement the final step.</p>
<h3 id=ol_start4_back_to_loops_ii ><a href="#ol_start4_back_to_loops_ii" class=header-anchor ><ol start=4 >
<li><p>Back to loops II</p>

</ol>
</a></h3>
<p>Duplicate <code>Pf_diffusion_2D_perf_loop.jl</code> and rename it as <code>Pf_diffusion_2D_perf_loop_fun.jl</code>.</p>
<p>In this last step, the goal is to define <code>compute</code> functions to hold the physics calculations, and to call those within the time loop.</p>
<p>Create a <code>compute_flux&#33;&#40;&#41;</code> and <code>compute_Pf&#33;&#40;&#41;</code> functions that take input and output arrays and needed scalars as argument and return nothing.</p>
<pre><code class="julia hljs"><span class=hljs-keyword >function</span> compute_flux!(...)
    nx,ny=size(Pf)
    ...
    <span class=hljs-keyword >return</span> <span class=hljs-literal >nothing</span>
<span class=hljs-keyword >end</span>

<span class=hljs-keyword >function</span> update_Pf!(Pf,...)
    nx,ny=size(Pf)
    ...
    <span class=hljs-keyword >return</span> <span class=hljs-literal >nothing</span>
<span class=hljs-keyword >end</span></code></pre>
<div class=note ><div class=title >💡 Note</div>
<div class=messg >Functions that modify arguments take a <code>&#33;</code> in their name, a Julia convention.</div></div>
<p>The <code>compute_flux&#33;&#40;&#41;</code> and <code>compute_Pf&#33;&#40;&#41;</code> functions can then be called within the time loop.</p>
<p>This last implementation executes a bit faster as previous one, as functions allow Julia to further optimise during just-ahead-of-time compilation.</p>
<div class=note ><div class=title >💡 Note</div>
<div class=messg >For optimal performance assessment, bound-checking should be deactivated. This can be achieved by adding <code>@inbounds</code> in front of the compute statement, or running the scripts &#40;or launching Julia&#41; with the <code>--check-bounds&#61;no</code> option.</div></div>
<p>Various timing and benchmarking tools are available in Julia&#39;s ecosystem to <a href="https://docs.julialang.org/en/v1/manual/performance-tips/">track performance issues</a>. Julia&#39;s <code>Base</code> exposes the <code>@time</code> macro which returns timing and allocation estimation. <a href="https://github.com/JuliaCI/BenchmarkTools.jl">BenchmarkTools.jl</a> package provides finer grained timing and benchmarking tooling, namely the <code>@btime</code>, <code>@belapsed</code> and <code>@benchmark</code> macros, among others.</p>
<p>Let&#39;s evaluate the performance of our code using <code>BenchmarkTools</code>. We will need to wrap the two compute kernels into a <code>compute&#33;&#40;&#41;</code> function in order to be able to call that one using <code>@belapsed</code>. Query <code>? @belapsed</code> in Julia&#39;s REPL to know more.</p>
<p>The <code>compute&#33;&#40;&#41;</code> function:</p>
<pre><code class="julia hljs"><span class=hljs-keyword >function</span> compute!(Pf,qDx,qDy, ???)
    compute_flux!(...)
    update_Pf!(...)
    <span class=hljs-keyword >return</span> <span class=hljs-literal >nothing</span>
<span class=hljs-keyword >end</span></code></pre>
<p>can then be called using <code>@belapsed</code> to return elapsed time for a single iteration, letting <code>BenchmarkTools</code> taking car about sampling</p>
<pre><code class="julia hljs">t_toc = <span class=hljs-meta >@belapsed</span> compute!($Pf,$qDx,$qDy,???)
niter = ???</code></pre>
<div class=note ><div class=title >💡 Note</div>
<div class=messg >Note that variables need to be interpolated into the function call, thus taking a <code>&#36;</code> in front.</div></div>
<h2 id=shared_memory_parallelisation ><a href="#shared_memory_parallelisation" class=header-anchor >Shared memory parallelisation</a></h2>
<p>Julia ships with it&#39;s <code>Base</code> feature the possibility to enable <a href="https://docs.julialang.org/en/v1/manual/multi-threading/">multi-threading</a>.</p>
<p>The only 2 modifications needed to enable it in our code are:</p>
<ol>
<li><p>Place <code>Threads.@threads</code> in front of the outer loop definition</p>

<li><p>Export the desired amount of threads, e.g., <code>export JULIA_NUM_THREADS&#61;4</code>, to be activate prior to launching Julia &#40;or executing the script from the shell&#41;. You can also launch Julia with <code>-t</code> option setting the desired numbers of threads. Setting <code>-t auto</code> will most likely automatically use as many hardware threads as available on a machine.</p>

</ol>
<p>The number of threads can be queried within a Julia session as following: <code>Threads.nthreads&#40;&#41;</code></p>
<div class=note ><div class=title >💡 Note</div>
<div class=messg >For optimal performance, the numbers of threads should be identical to the  number of physical cores of the target CPU &#40;hardware threads&#41;.</div></div>
<h3 id=multi-threading_avx_and_simd ><a href="#multi-threading_avx_and_simd" class=header-anchor >Multi-threading, AVX and SIMD</a></h3>
<p>Julia&#39;s ecosystem offers various approaches to try supporting SIMD operations.</p>
<p>Using <a href="https://github.com/JuliaSIMD/LoopVectorization.jl">LoopVectorization.jl</a>, it is possible to combine multi-threading with <a href="https://en.wikipedia.org/wiki/Advanced_Vector_Extensions">advanced vector extensions &#40;AVX&#41;</a> optimisations, leveraging extensions to the x86 instruction set architecture.</p>
<p>Julia base also exposes <a href="https://docs.julialang.org/en/v1/base/base/#Base.SimdLoop.@simd"><code>@simd</code> macro</a> that would possibly enable the compiler to take extra liberties to allow loop re-ordering.</p>
<p>To enable LoopVectorization:</p>
<ol>
<li><p>Add <code>using LoopVectorization</code> at the top of the script</p>

<li><p>Replace <code>Threads.@threads</code> by <code>@tturbo</code></p>

</ol>
<p>To try making use of SIMD, decorate the <code>for</code> loop with <code>@simd for</code>.</p>
<div class=note ><div class=title >💡 Note</div>
<div class=messg >These features are still experimental and could change in future versions of Julia. Incorrect use of the @simd macro may cause unexpected results.</div></div>
<h3 id=wrapping-up ><a href="#wrapping-up" class=header-anchor >Wrapping-up</a></h3>
<ul>
<li><p>We discussed main performance limiters</p>

<li><p>We implemented the effective memory throughput metric <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{eff}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></p>

<li><p>We optimised the Julia 2D diffusion code &#40;multi-threading and AVX&#41;</p>

</ul>

<p><a href="#content">⤴ <em><strong>back to Content</strong></em></a></p>
<h1 id=unit_testing_in_julia ><a href="#unit_testing_in_julia" class=header-anchor >Unit testing in Julia</a></h1>
<h3 id=the_julia_test_module ><a href="#the_julia_test_module" class=header-anchor >The Julia <code>Test</code> module</a></h3>
<p><a href="https://docs.julialang.org/en/v1/stdlib/Test/#Basic-Unit-Tests">Basic unit tests</a> in Julia</p>
<ul>
<li><p>Provides simple <em>unit testing</em> functionality</p>

<li><p>A way to assess if code is correct by checking that results are as expected</p>

<li><p>Helpful to ensure the code still works after changes</p>

<li><p>Can be used when developing</p>

<li><p>Should be used in package for continous integration &#40;aka CI; when tests are run on GitHub automatically on a push&#41;</p>

</ul>
<h2 id=basic_unit_tests ><a href="#basic_unit_tests" class=header-anchor >Basic unit tests</a></h2>
<p>Simple unit testing can be performed with the <code>@test</code> and <code>@test_throws</code> macros:</p>
<pre><code class="julia hljs"><span class=hljs-keyword >using</span> Test

<span class=hljs-meta >@test</span> <span class=hljs-number >1</span>==<span class=hljs-number >1</span>

<span class=hljs-meta >@test_throws</span> <span class=hljs-built_in >MethodError</span> <span class=hljs-number >1</span>+<span class=hljs-string >&quot;a&quot;</span> <span class=hljs-comment >## the expected error must be provided too</span></code></pre>
<p>Or another example</p>
<pre><code class="julia hljs"><span class=hljs-meta >@test</span> [<span class=hljs-number >1</span>, <span class=hljs-number >2</span>] + [<span class=hljs-number >2</span>, <span class=hljs-number >1</span>] == [<span class=hljs-number >3</span>, <span class=hljs-number >3</span>]</code></pre>
<p>Testing an expression which is a call using infix syntax such as approximate comparisons &#40;<code>\approx</code> &#43; tab&#41;</p>
<pre><code class="julia hljs"><span class=hljs-meta >@test</span> <span class=hljs-literal >π</span> ≈ <span class=hljs-number >3.14</span> atol=<span class=hljs-number >0.01</span></code></pre>
<p>For example, suppose we want to check our new function <code>square&#40;x&#41;</code> works as expected:</p>
<pre><code class="julia hljs">square(x) = x^<span class=hljs-number >2</span></code></pre>
<p>If the condition is true, a <code>Pass</code> is returned:</p>
<pre><code class="julia hljs"><span class=hljs-meta >@test</span> square(<span class=hljs-number >5</span>) == <span class=hljs-number >25</span></code></pre>
<p>If the condition is false, then a <code>Fail</code> is returned and an exception is thrown:</p>
<pre><code class="julia hljs"><span class=hljs-meta >@test</span> square(<span class=hljs-number >5</span>) == <span class=hljs-number >20</span></code></pre>
<pre><code class="julia hljs">Test Failed at none:<span class=hljs-number >1</span>
  Expression: square(<span class=hljs-number >5</span>) == <span class=hljs-number >20</span>
   Evaluated: <span class=hljs-number >25</span> == <span class=hljs-number >20</span>
Test.FallbackTestSetException(<span class=hljs-string >&quot;There was an error during testing&quot;</span>)</code></pre>
<h2 id=working_with_a_test_sets ><a href="#working_with_a_test_sets" class=header-anchor >Working with a test sets</a></h2>
<p>The <code>@testset</code> macro can be used to group <a href="https://docs.julialang.org/en/v1/stdlib/Test/#Working-with-Test-Sets">tests into sets</a>.</p>
<p>All the tests in a test set will be run, and at the end of the test set a summary will be printed.</p>
<p>If any of the tests failed, or could not be evaluated due to an error, the test set will then throw a <code>TestSetException</code>.</p>
<pre><code class="julia hljs"><span class=hljs-meta >@testset</span> <span class=hljs-string >&quot;trigonometric identities&quot;</span> <span class=hljs-keyword >begin</span>
    θ = <span class=hljs-number >2</span>/<span class=hljs-number >3</span>*<span class=hljs-literal >π</span>
    <span class=hljs-meta >@test</span> sin(-θ) ≈ -sin(θ)
    <span class=hljs-meta >@test</span> cos(-θ) ≈ cos(θ)
    <span class=hljs-meta >@test</span> sin(<span class=hljs-number >2</span>θ) ≈ <span class=hljs-number >2</span>*sin(θ)*cos(θ)
    <span class=hljs-meta >@test</span> cos(<span class=hljs-number >2</span>θ) ≈ cos(θ)^<span class=hljs-number >2</span> - sin(θ)^<span class=hljs-number >2</span>
<span class=hljs-keyword >end</span>;</code></pre>
<p>Let&#39;s try it with our <code>square&#40;&#41;</code> function</p>
<pre><code class="julia hljs">square(x) = x^<span class=hljs-number >2</span>

<span class=hljs-meta >@testset</span> <span class=hljs-string >&quot;Square Tests&quot;</span> <span class=hljs-keyword >begin</span>
    <span class=hljs-meta >@test</span> square(<span class=hljs-number >5</span>) == <span class=hljs-number >25</span>
    <span class=hljs-meta >@test</span> square(<span class=hljs-string >&quot;a&quot;</span>) == <span class=hljs-string >&quot;aa&quot;</span>
    <span class=hljs-meta >@test</span> square(<span class=hljs-string >&quot;bb&quot;</span>) == <span class=hljs-string >&quot;bbbb&quot;</span>
<span class=hljs-keyword >end</span>;</code></pre>
<p>If we now introduce a bug</p>
<pre><code class="julia hljs">square(x) = x^<span class=hljs-number >2</span>

<span class=hljs-meta >@testset</span> <span class=hljs-string >&quot;Square Tests&quot;</span> <span class=hljs-keyword >begin</span>
    <span class=hljs-meta >@test</span> square(<span class=hljs-number >5</span>) == <span class=hljs-number >25</span>
    <span class=hljs-meta >@test</span> square(<span class=hljs-string >&quot;a&quot;</span>) == <span class=hljs-string >&quot;aa&quot;</span>
    <span class=hljs-meta >@test</span> square(<span class=hljs-string >&quot;bb&quot;</span>) == <span class=hljs-string >&quot;bbbb&quot;</span>
    <span class=hljs-meta >@test</span> square(<span class=hljs-number >5</span>) == <span class=hljs-number >20</span>
<span class=hljs-keyword >end</span>;</code></pre>
<pre><code class="julia hljs">Square Tests: Test Failed at none:<span class=hljs-number >6</span>
  Expression: square(<span class=hljs-number >5</span>) == <span class=hljs-number >20</span>
   Evaluated: <span class=hljs-number >25</span> == <span class=hljs-number >20</span>
Stacktrace:
 [...]
Test Summary: | Pass  Fail  Total
Square Tests  |    <span class=hljs-number >3</span>     <span class=hljs-number >1</span>      <span class=hljs-number >4</span>
<span class=hljs-built_in >Some</span> tests did not pass: <span class=hljs-number >3</span> passed, <span class=hljs-number >1</span> failed, <span class=hljs-number >0</span> errored, <span class=hljs-number >0</span> broken.</code></pre>
<p>Then then the reporting tells us a test failed.</p>
<h3 id=where_to_put_them_how_to_run_them ><a href="#where_to_put_them_how_to_run_them" class=header-anchor >Where to put them, how to run them</a></h3>
<p>The simplest is to just put the tests in your script, along the tested function. Then the tests run every time the script is executed.</p>
<p>However, for bigger pieces of software, such as packages, this becomes unwieldly and also undesired &#40;as we don&#39;t want tests to run all the time&#41;.  Then tests are put into <code>test/runtests.jl</code>.  If they are there they will be run when called from package mode or from automated test &#40;CI&#41;.</p>
<p>Example for the package <code>Literate.jl</code> &#40;we use that to generate the website&#41;:</p>
<pre><code class="julia hljs">julia&gt; <span class=hljs-keyword >using</span> Pkg

julia&gt; Pkg.test(<span class=hljs-string >&quot;Literate&quot;</span>)
     Testing Literate
   ...
     Testing Running tests...
Test Summary:  | Pass  Total  Time
Literate.parse |  <span class=hljs-number >533</span>    <span class=hljs-number >533</span>  <span class=hljs-number >0.8</span>s
Test Summary:   | Pass  Broken  Total  Time
Literate.script |   <span class=hljs-number >36</span>       <span class=hljs-number >1</span>     <span class=hljs-number >37</span>  <span class=hljs-number >2.1</span>s
Test Summary:     | Pass  Broken  Total  Time
Literate.markdown |   <span class=hljs-number >82</span>       <span class=hljs-number >2</span>     <span class=hljs-number >84</span>  <span class=hljs-number >4.3</span>s
Test Summary:     | Pass  Broken  Total  Time
Literate.notebook |   <span class=hljs-number >86</span>       <span class=hljs-number >1</span>     <span class=hljs-number >87</span>  <span class=hljs-number >5.2</span>s
Test Summary: | Pass  Total  Time
Configuration |    <span class=hljs-number >7</span>      <span class=hljs-number >7</span>  <span class=hljs-number >0.3</span>s
     Testing Literate tests passed</code></pre>
<h3 id=wrapping-up__2 ><a href="#wrapping-up__2" class=header-anchor >Wrapping-up</a></h3>
<ul>
<li><p>The <code>Test</code> module provides simple <em>unit testing</em> functionality.</p>

<li><p>Tests can be grouped into sets using <code>@testset</code>.</p>

<li><p>We&#39;ll later see how tests can be used in CI.</p>

</ul>

<p><a href="#content">⤴ <em><strong>back to Content</strong></em></a></p>
<h1 id=exercises_-_lecture_6 ><a href="#exercises_-_lecture_6" class=header-anchor >Exercises - lecture 6</a></h1>
<div class=warning ><div class=title >⚠️ Warning&#33;</div>
<div class=messg >Exercises have to be handed in as monolithic Julia scripts &#40;one code per script&#41; and uploaded to your private &#40;shared&#41; GitHub repository, in a <strong>specific folder for each lecture</strong>. The git commit hash &#40;or SHA&#41; of the final push needs to be uploaded on Moodle &#40;<a href="/homework">more</a>&#41;.</div></div>
<h2 id=exercise_1_performance_implementation ><a href="#exercise_1_performance_implementation" class=header-anchor >Exercise 1 — <strong>Performance implementation</strong></a></h2>
<p>👉 See <a href="/logistics/#submission">Logistics</a> for submission details.</p>
<p>The goal of this exercise is to:</p>
<ul>
<li><p>Finalise the script discussed in class</p>

</ul>
<p>In this first exercise, you will terminate the performance oriented implementation of the 2D fluid pressure &#40;diffusion&#41; solver script from lecture 6.</p>
<p>👉 If needed, download the <a href="https://github.com/eth-vaw-glaciology/course-101-0250-00/blob/main/scripts/"><code>l6_Pf_diffusion_2D.jl</code></a> to get you started.</p>
<h3 id=task_1 ><a href="#task_1" class=header-anchor >Task 1</a></h3>
<p>Create a new folder in your GitHub repository for this week&#39;s &#40;lecture 6&#41; exercises. In there, create a new subfolder <code>Pf_diffusion_2D</code> where you will add following script:</p>
<ul>
<li><p><code>Pf_diffusion_2D_Teff.jl</code>: <code>T_eff</code> implementation</p>

<li><p><code>Pf_diffusion_2D_perf.jl</code>: scalar precomputations and removing disabling <code>ncheck</code></p>

<li><p><code>Pf_diffusion_2D_loop_fun.jl</code>: physics computations in <code>compute&#33;&#40;&#41;</code> function, derivatives done with macros, and multi-threading</p>

</ul>
<div class=note ><div class=title >💡 Note</div>
<div class=messg >Refer to <a href="#timer_and_performance">this section</a> in lecture 6 to capture the starting point describing which features are specific to each version of the diffusion 2D codes.</div></div>

<p><a href="#content">⤴ <em><strong>back to Content</strong></em></a></p>
<hr />
<h2 id=exercise_2_performance_evaluation ><a href="#exercise_2_performance_evaluation" class=header-anchor >Exercise 2 — <strong>Performance evaluation</strong></a></h2>
<p>👉 See <a href="/logistics/#submission">Logistics</a> for submission details.</p>
<p>The goal of this exercise is to:</p>
<ul>
<li><p>Create a script to assess <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >p</mi><mi mathvariant=normal >e</mi><mi mathvariant=normal >a</mi><mi mathvariant=normal >k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{peak}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.969438em;vertical-align:-0.286108em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">p</span><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight">a</span><span class="mord mathrm mtight">k</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>, using memory-copy</p>

<li><p>Assess <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >p</mi><mi mathvariant=normal >e</mi><mi mathvariant=normal >a</mi><mi mathvariant=normal >k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{peak}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.969438em;vertical-align:-0.286108em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">p</span><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight">a</span><span class="mord mathrm mtight">k</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> of your CPU</p>

<li><p>Perform a strong-scaling test: assess <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{eff}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> for the fluid pressure diffusion 2D solver as function of number of grid points and implementation</p>

</ul>
<p>For this exercise, you will write a code to assess the peak memory throughput of your CPU and run a strong scaling benchmark using the fluid pressure diffusion 2D solver and report performance.</p>
<h3 id=task_1__2 ><a href="#task_1__2" class=header-anchor >Task 1</a></h3>
<p>In the <code>Pf_diffusion_2D</code> folder, create a new script named <code>memcopy.jl</code>. You can use as starting point the <code>diffusion_2D_loop_fun.jl</code> script from lecture 6 &#40;or exercise 1&#41;.</p>
<ol>
<li><p>Rename the &quot;main&quot; function <code>memcopy&#40;&#41;</code></p>

<li><p>Modify the script to only keep following in the initialisation:</p>

</ol>
<pre><code class="julia hljs"><span class=hljs-comment ># Numerics</span>
nx, ny  = <span class=hljs-number >512</span>, <span class=hljs-number >512</span>
nt      = <span class=hljs-number >2e4</span>
<span class=hljs-comment ># array initialisation</span>
C       = rand(<span class=hljs-built_in >Float64</span>, nx, ny)
C2      = copy(C)
A       = copy(C)</code></pre>
<ol start=3 >
<li><p>Implement 2 compute functions to perform the following operation <code>C2 &#61; C &#43; A</code>, replacing the previous calculations:</p>
<ul>
<li><p>create an &quot;array programming&quot;-based function called <code>compute_ap&#33;&#40;&#41;</code> that includes a broadcasted version of the memory copy operation;</p>

<li><p>create a second &quot;kernel programming&quot;-based function called <code>compute_kp&#33;&#40;&#41;</code> that uses a loop-based implementation with multi-threading.</p>

</ul>

<li><p>Update the <code>A_eff</code> formula accordingly.</p>

<li><p>Implement a switch to monitor performance using either a manual approach or <code>BenchmarkTools</code> and pass the <code>bench</code> value as kwarg to the <code>memcopy&#40;&#41;</code> main function including a default:</p>

</ol>
<pre><code class="julia hljs"><span class=hljs-keyword >if</span> bench == :loop
    <span class=hljs-comment ># iteration loop</span>
    t_tic = <span class=hljs-number >0.0</span>
    <span class=hljs-keyword >for</span> iter=<span class=hljs-number >1</span>:nt
      ...
    <span class=hljs-keyword >end</span>
    t_toc = Base.time() - t_tic
<span class=hljs-keyword >elseif</span> bench == :btool
    t_toc = <span class=hljs-meta >@belapsed</span> ...
<span class=hljs-keyword >end</span></code></pre>
<p>Then, create a <code>README.md</code> file in the <code>Pf_diffusion_2D</code> folder to report the results for each of the following tasks &#40;including a .png of the figure when instructed&#41;</p>
<div class=note ><div class=title >💡 Note</div>
<div class=messg >Use <code>&#33;&#91;fig_name&#93;&#40;./&lt;relative-path&gt;/my_fig.png&#41;</code> to insert a .png figure in the <code>README.md</code>.</div></div>
<h3 id=task_2 ><a href="#task_2" class=header-anchor >Task 2</a></h3>
<p>Report on a figure <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{eff}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> of your <code>memcopy.jl</code> code as function of number of grid points <code>nx × ny</code> for the array and kernel programming approaches, respectively, using the <code>BenchmarkTools</code> implementation. Vary <code>nx</code>and <code>ny</code> such that</p>
<pre><code class="julia hljs">nx = ny = <span class=hljs-number >16</span> * <span class=hljs-number >2</span> .^ (<span class=hljs-number >1</span>:<span class=hljs-number >8</span>)</code></pre>
<p><em>&#40;<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{eff}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> of your <code>memcopy.jl</code> code represents <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >p</mi><mi mathvariant=normal >e</mi><mi mathvariant=normal >a</mi><mi mathvariant=normal >k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{peak}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.969438em;vertical-align:-0.286108em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">p</span><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight">a</span><span class="mord mathrm mtight">k</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>, the peak memory throughput you can achieve on your CPU for a given implementation.&#41;</em></p>
<p>On the same figure, report the best value of memcopy obtained using the manual loop-based approach &#40;manual timer&#41; to assess <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >p</mi><mi mathvariant=normal >e</mi><mi mathvariant=normal >a</mi><mi mathvariant=normal >k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{peak}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.969438em;vertical-align:-0.286108em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">p</span><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight">a</span><span class="mord mathrm mtight">k</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>.</p>
<div class=note ><div class=title >💡 Note</div>
<div class=messg >For performance evaluation we only need the code to run a couple of seconds; adapt <code>nt</code> accordingly &#40;you could also, e.g., make <code>nt</code> function of <code>nx, ny</code>&#41;. Ensure also to implement &quot;warm-up&quot; iterations.</div></div>
<p>Add the above figure in a new section of the <code>Pf_diffusion_2D/README.md</code>, and provide a minimal description of 1&#41; the performed test, and 2&#41; a short description of the result. Figure out the vendor-announced peak memory bandwidth for your CPU, add it to the figure and use it to discuss your results.</p>
<h3 id=task_3 ><a href="#task_3" class=header-anchor >Task 3</a></h3>
<p>Repeat the strong scaling benchmark you just realised in Task 2 using the various fluid pressure diffusion 2D codes &#40;<code>Pf_diffusion_2D_Teff.jl</code>; <code>Pf_diffusion_2D_perf.jl</code>; <code>Pf_diffusion_2D_loop_fun.jl</code> - with/without <code>Threads.@threads</code> for the latter&#41;.</p>
<p>Report on a figure <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{eff}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> of the 4 diffusion solvers&#39; implementations as function of number of grid points <code>nx × ny</code>. Vary <code>nx</code>and <code>ny</code> such that <code>nx &#61; ny &#61; 16 * 2 .^ &#40;1:8&#41;</code>. <strong>Use the <code>BenchmarlTools</code>-based evaluation approach.</strong></p>
<p>On the same figure, report also the best memory copy value &#40;as, e.g, dashed lines&#41; and vendor announced values &#40;if available - optional&#41;.</p>
<p>Add this second figure in a new section of the <code>Pf_diffusion_2D/README.md</code>, and provide a minimal description of 1&#41; the performed test, and 2&#41; a short description of the result.</p>

<p><a href="#content">⤴ <em><strong>back to Content</strong></em></a></p>
<hr />
<h2 id=exercise_3_unit_tests ><a href="#exercise_3_unit_tests" class=header-anchor >Exercise 3 — <strong>Unit tests</strong></a></h2>
<p>👉 See <a href="/logistics/#submission">Logistics</a> for submission details.</p>
<p>The goal of this exercise is to:</p>
<ul>
<li><p>Implement basic unit tests for the diffusion and acoustic 2D scripts</p>

<li><p>Group the tests in a test-set</p>

</ul>
<p>For this exercise, you will implement a test set of basic unit tests using Julia&#39;s built-in testing infrastructure to verify the implementation of the diffusion and acoustic 2D solvers.</p>
<h3 id=task_1__3 ><a href="#task_1__3" class=header-anchor >Task 1</a></h3>
<p>In the <code>Pf_diffusion_2D</code> folder, duplicate the <code>Pf_diffusion_2D_perf_loop_fun.jl</code> script and rename it <code>Pf_diffusion_2D_test.jl</code>.</p>
<p>Implement a test set using <code>@testset</code> and <code>@test</code> macros from Test.jl in order to test <code>Pf&#91;xtest, ytest&#93;</code> and assess that the values returned are approximatively equal to the following ones for the given values of <code>nx &#61; ny</code>. Make sure to set <code>do_check &#61; false</code> i.e. to ensure the code to run 500 iterations.</p>
<pre><code class="julia hljs">xtest = [<span class=hljs-number >5</span>, <span class=hljs-built_in >Int</span>(cld(<span class=hljs-number >0.6</span>*lx, dx)), nx-<span class=hljs-number >10</span>]
ytest = <span class=hljs-built_in >Int</span>(cld(<span class=hljs-number >0.5</span>*ly, dy))</code></pre>
<p>for</p>
<pre><code class="julia hljs">nx = ny = <span class=hljs-number >16</span> * <span class=hljs-number >2</span> .^ (<span class=hljs-number >2</span>:<span class=hljs-number >5</span>) .- <span class=hljs-number >1</span>
maxiter = <span class=hljs-number >500</span></code></pre>
<p>should match</p>
<table><tr><th align=center ><code>nx, ny</code><th align=center ><code>Pf&#91;xtest, ytest&#93;</code><tr><td align=center ><code>63</code><td align=center ><code>&#91;0.00785398056115133 0.007853980637555755 0.007853978592411982&#93;</code><tr><td align=center ><code>127</code><td align=center ><code>&#91;0.00787296974549236 0.007849556884184108 0.007847181374079883&#93;</code><tr><td align=center ><code>255</code><td align=center ><code>&#91;0.00740912103848251 0.009143711648167267 0.007419533048751209&#93;</code><tr><td align=center ><code>511</code><td align=center ><code>&#91;0.00566813765849919 0.004348785338575644 0.005618691590498087&#93;</code></table>
<p>Report the output of the test set as code block in a new section of the <code>README.md</code> in the <code>Pf_diffusion_2D</code> folder.</p>
<div class=note ><div class=title >💡 Note</div>
<div class=messg >Use triple backticks to generate code blocks in the <code>README.md</code> &#40;<a href="https://www.markdownguide.org/extended-syntax/#fenced-code-blocks">more</a>&#41;.</div></div>

<p><a href="#content">⤴ <em><strong>back to Content</strong></em></a></p>
<div class=page-foot >
  <div class=copyright >
    <a href="https://github.com/eth-vaw-glaciology/course-101-0250-00/"><b>Edit this page on <img class=github-logo  src="https://unpkg.com/ionicons@5.1.2/dist/svg/logo-github.svg"></b></a><br>
    Last modified: October 28, 2025. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>.
  </div>
</div>
</div>
    </div>