<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/course-101-0250-00/libs/katex/katex.min.css"> <link rel=stylesheet  href="/course-101-0250-00/libs/highlight/github.min.css"> <link rel=stylesheet  href="/course-101-0250-00/css/franklin.css"> <link rel=stylesheet  href="/course-101-0250-00/css/poole_hyde.css"> <link rel=stylesheet  href="/course-101-0250-00/css/custom.css"> <style> html {font-size: 17px;} .franklin-content {position: relative; padding-left: 8%; padding-right: 5%; line-height: 1.35em;} @media (min-width: 940px) { .franklin-content {width: 100%; margin-left: auto; margin-right: auto;} } @media (max-width: 768px) { .franklin-content {padding-left: 6%; padding-right: 6%;} } </style> <link rel=icon  href="/course-101-0250-00/assets/favicon.png"> <title>Lecture 5</title> <style> .content {max-width: 50rem} </style> <div class=sidebar > <div class="container sidebar-sticky"> <div class=sidebar-about > <img src="/course-101-0250-00/assets/vaw_logo.png" style="width: 180px; height: auto; display: inline"> <div style="font-weight: margin-bottom: 0.5em"><a href="/course-101-0250-00/"> Fall 2021</a> <span style="opacity: 0.7;">| <a href="http://www.vvz.ethz.ch/Vorlesungsverzeichnis/lerneinheit.view?semkez=2021W&ansicht=KATALOGDATEN&lerneinheitId=155538&lang=en"> ETHZ 101-0250-00</a></span></div> <br> <h1><a href="/course-101-0250-00/">Solving partial differential equations in parallel on GPUs</a></h1> <div style="line-height:18px; font-size: 15px; opacity: 0.85">by <a href="https://vaw.ethz.ch/en/people/person-detail.MjcwOTYw.TGlzdC8xOTYxLDE1MTczNjI1ODA=.html">Ludovic Räss</a>, <a href="https://vaw.ethz.ch/en/personen/person-detail.html?persid=124402">Mauro Werder</a> & <a href="https://www.cscs.ch/about/staff/">Samuel Omlin</a> </div> </div> <br> <style> </style> <nav class=sidebar-nav  style="opacity: 0.9"> <a class="sidebar-nav-item " href="/course-101-0250-00/"><b>Welcome</b></a> <a class="sidebar-nav-item " href="/course-101-0250-00/logistics/">Logistics</a> <a class="sidebar-nav-item " href="/course-101-0250-00/homework/">Homework</a> <a class="sidebar-nav-item " href="/course-101-0250-00/software_install/">Software install</a> <a class="sidebar-nav-item " href="/course-101-0250-00/extras/">Extras</a> <br> <div class=course-section >Part 1 - Introduction</div> <a class="sidebar-nav-item " href="/course-101-0250-00/lecture1/">Lecture 1</a> <a class="sidebar-nav-item " href="/course-101-0250-00/lecture2/">Lecture 2</a> <a class="sidebar-nav-item " href="/course-101-0250-00/lecture3/">Lecture 3</a> <a class="sidebar-nav-item " href="/course-101-0250-00/lecture4/">Lecture 4</a> <div class=course-section >Part 2 - Solving PDEs on GPUs</div> <a class="sidebar-nav-item active" href="/course-101-0250-00/lecture5/">Lecture 5</a> <div class=course-section >Part 3 - Projects</div> </nav> </div> </div> <div class="content container"> <div class=franklin-content > <h1 id=lecture_5 ><a href="#lecture_5" class=header-anchor >Lecture 5</a></h1> <blockquote> <p><strong>Agenda</strong><br />📚 Parallel computing on CPUs &amp; performance assessment, the <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{eff}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> metric<br />💻 Unit testing in Julia<br />🚧 Exercises:</p> <ul> <li><p>Dual-time stepping</p> <li><p>CPU HPC for acoustic</p> <li><p>Test set implementation</p> </ul> </blockquote> <p><hr /> </p> <p><a id=content  class=anchor ></a> <strong>Content</strong></p> <div class=franklin-toc ><ol><li><a href="#lecture_5">Lecture 5</a><li><a href="#parallel_computing_on_cpus_and_performance_assessment">Parallel computing &#40;on CPUs&#41; and performance assessment</a><ol><li><a href="#performance_limiters">Performance limiters</a><li><a href="#effective_memory_throughput_metric">Effective memory throughput metric</a><li><a href="#parallel_computing_on_cpus">Parallel computing on CPUs</a></ol><li><a href="#unit_testing_in_julia">Unit testing in Julia</a><ol><li><a href="#basic_unit_tests">Basic unit tests</a><li><a href="#working_with_a_test_sets">Working with a test sets</a></ol><li><a href="#exercises_-_lecture_5">Exercises - lecture 5</a></ol></div> <p><a href="#exercises_-_lecture_5"><em>👉 get started with exercises</em></a></p> <hr /> <h1 id=parallel_computing_on_cpus_and_performance_assessment ><a href="#parallel_computing_on_cpus_and_performance_assessment" class=header-anchor >Parallel computing &#40;on CPUs&#41; and performance assessment</a></h1> <h3 id=the_goal_of_this_lecture_5_is_to_introduce ><a href="#the_goal_of_this_lecture_5_is_to_introduce" class=header-anchor >The goal of this lecture 5 is to introduce:</a></h3> <ul> <li><p>Performance limiters</p> <li><p>Effective memory throughput metric <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{eff}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></p> <li><p>Parallel computing on CPUs</p> <li><p>Shared memory parallelisation</p> </ul> <h2 id=performance_limiters ><a href="#performance_limiters" class=header-anchor >Performance limiters</a></h2> <h3 id=hardware ><a href="#hardware" class=header-anchor >Hardware</a></h3> <ul> <li><p>Multi-core CPUs &#40;and GPUs&#41; are throughput-oriented systems</p> <li><p>They use their massive parallelism to hide latency</p> </ul> <p><em>Recall from <a href="lecture1/#why_we_do_it">lecture 1</a> ...</em></p> <p>Use <strong>parallel computing</strong> &#40;to address this&#41;:</p> <ul> <li><p>The &quot;memory wall&quot; in ~ 2004</p> <li><p>Single-core to multi-core devices</p> </ul> <p><img src="../assets/literate_figures/mem_wall.png" alt=mem_wall  /></p> <p>GPUs are massively parallel devices</p> <ul> <li><p>SIMD machine &#40;programmed using threads - SPMD&#41; &#40;<a href="https://safari.ethz.ch/architecture/fall2020/lib/exe/fetch.php?media&#61;onur-comparch-fall2020-lecture24-simdandgpu-afterlecture.pdf">more</a>&#41;</p> <li><p>Further increases the Flop vs Bytes gap</p> </ul> <p><img src="../assets/literate_figures/cpu_gpu_evo.png" alt=cpu_gpu_evo  /></p> <p>If we look at an</p> <ul> <li><p>Nvidia Tesla A100 GPU</p> <li><p>AMD EPYC &quot;Rome&quot; 7282 &#40;16 cores&#41; CPU</p> </ul> <table><tr><th align=center >Device<th align=center >TFLOPS &#40;FP64&#41;<th align=center >Memory BW TB/s<th align=center >Ratio<tr><td align=center >Tesla A100<td align=center >9.7<td align=center >1.55<td align=center >6.23<tr><td align=center >AMD EPYC 7282<td align=center >0.7<td align=center >0.085<td align=center >8.23</table> <p>➡ Memory bound: requires to re-think the numerical implementation and solution strategies</p> <h3 id=on_the_scientific_application_side ><a href="#on_the_scientific_application_side" class=header-anchor >On the scientific application side</a></h3> <ul> <li><p>Most algorithms require only a few operations or flops ...</p> <li><p>... compared to the amount of numbers or bytes accessed from main memory.</p> </ul> <p>First derivative example</p> <p>If we &quot;naively&quot; compare the &quot;cost&quot; of evaluating a finite-difference first derivative, e.g., computing a flux <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span></span></span></span>:</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mi>q</mi><mo>=</mo><mo>−</mo><mi>D</mi><mtext> </mtext><mfrac><mrow><mi mathvariant=normal >∂</mi><mi>A</mi></mrow><mrow><mi mathvariant=normal >∂</mi><mi>x</mi></mrow></mfrac><mtext> </mtext><mo separator=true >,</mo></mrow><annotation encoding="application/x-tex">q = -D~\frac{∂A}{∂x}~,</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:2.05744em;vertical-align:-0.686em;"></span><span class=mord >−</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mspace nobreak"> </span><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.37144em;"><span style="top:-2.314em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord  style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">x</span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord  style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">A</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace nobreak"> </span><span class=mpunct >,</span></span></span></span></span> <p>which in the discrete form reads <code>q&#91;ix&#93; &#61; -D*&#40;A&#91;ix&#43;1&#93;-A&#91;ix&#93;&#41;/dx</code>.</p> <p>The cost of evaluating <code>q&#91;ix&#93; &#61; -D*&#40;A&#91;ix&#43;1&#93;-A&#91;ix&#93;&#41;/dx</code>:</p> <p>2 reads &#43; 1 write &#61;&gt; <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn><mo>×</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">3 × 8</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.72777em;vertical-align:-0.08333em;"></span><span class=mord >3</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >×</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >8</span></span></span></span> &#61; <strong>24 bytes transferred</strong></p> <p>1 &#40;fused&#41; addition and division &#61;&gt; <strong>1 &#40;2&#41; floating point operations</strong></p> <p>assuming:</p> <ul> <li><p><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span></span>, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=normal >∂</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">∂x</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.69444em;vertical-align:0em;"></span><span class=mord  style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">x</span></span></span></span> are scalars</p> <li><p><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">A</span></span></span></span> are arrays of <code>Float64</code> &#40;read from global memory&#41;</p> </ul> <p>Comparing to the machine balances:</p> <table><tr><th align=center >Device<th align=center >TFLOPS &#40;FP64&#41;<th align=center >Memory BW TB/s<th align=center >Ratio<tr><td align=center >Tesla A100<td align=center >9.7<td align=center >1.55<td align=center >6.23<tr><td align=center >AMD EPYC 7282<td align=center >0.7<td align=center >0.085<td align=center >8.23<tr><td align=center ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=normal >∂</mi><mi>A</mi><mi mathvariant=normal >/</mi><mi mathvariant=normal >∂</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">∂A/∂x</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord  style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">A</span><span class=mord >/</span><span class=mord  style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">x</span></span></span></span><td align=center >1 &#40;<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>×</mo><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>12</mn></mrow></msup></mrow><annotation encoding="application/x-tex">×10^{-12}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.897438em;vertical-align:-0.08333em;"></span><span class=mord >×</span><span class=mord >1</span><span class=mord ><span class=mord >0</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>&#41;<td align=center >24 &#40;<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>×</mo><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>12</mn></mrow></msup></mrow><annotation encoding="application/x-tex">×10^{-12}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.897438em;vertical-align:-0.08333em;"></span><span class=mord >×</span><span class=mord >1</span><span class=mord ><span class=mord >0</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>&#41;<td align=center >0.041</table> <p>0.041 &lt;&lt; 6.23 or 8.23, and so we are memory-bound</p> <p>The Flop/s metric is no longer the most adequate for reporting the application performance of many modern applications.</p> <h2 id=effective_memory_throughput_metric ><a href="#effective_memory_throughput_metric" class=header-anchor >Effective memory throughput metric</a></h2> <p>Need for a memory throughput-based performance evaluation metric: <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{eff}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> &#91;GB/s&#93;</p> <p>➡ Evaluate the performance of iterative stencil-based solvers.</p> <p>The effective memory access <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub></mrow><annotation encoding="application/x-tex">A_\mathrm{eff}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal">A</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> &#91;GB&#93;</p> <p>Sum of:</p> <ul> <li><p>twice the memory footprint of the unknown fields, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mi mathvariant=normal >u</mi></msub></mrow><annotation encoding="application/x-tex">D_\mathrm{u}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">u</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, &#40;fields that depend on their own history and that need to be updated every iteration&#41;</p> <li><p>known fields, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mi mathvariant=normal >k</mi></msub></mrow><annotation encoding="application/x-tex">D_\mathrm{k}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">k</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, that do not change every iteration.</p> </ul> <p>The effective memory access divided by the execution time per iteration, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mrow><mi mathvariant=normal >i</mi><mi mathvariant=normal >t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">t_\mathrm{it}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.76508em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal">t</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.31750199999999995em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">i</span><span class="mord mathrm mtight">t</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> &#91;sec&#93;, defines the effective memory throughput, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{eff}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> &#91;GB/s&#93;:</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><msub><mi>A</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub><mo>=</mo><mn>2</mn><mtext> </mtext><msub><mi>D</mi><mi mathvariant=normal >u</mi></msub><mo>+</mo><msub><mi>D</mi><mi mathvariant=normal >k</mi></msub></mrow><annotation encoding="application/x-tex"> A_\mathrm{eff} = 2~D_\mathrm{u} + D_\mathrm{k} </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal">A</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord >2</span><span class="mspace nobreak"> </span><span class=mord ><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">u</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">k</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub><mo>=</mo><mfrac><msub><mi>A</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub><msub><mi>t</mi><mrow><mi mathvariant=normal >i</mi><mi mathvariant=normal >t</mi></mrow></msub></mfrac></mrow><annotation encoding="application/x-tex"> T_\mathrm{eff} = \frac{A_\mathrm{eff}}{t_\mathrm{it}} </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:2.19633em;vertical-align:-0.8360000000000001em;"></span><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.36033em;"><span style="top:-2.3139999999999996em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class="mord mathnormal">t</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.31750199999999995em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">i</span><span class="mord mathrm mtight">t</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord ><span class="mord mathnormal">A</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.8360000000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span> <p>The upper bound of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{eff}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >p</mi><mi mathvariant=normal >e</mi><mi mathvariant=normal >a</mi><mi mathvariant=normal >k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{peak}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.969438em;vertical-align:-0.286108em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">p</span><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight">a</span><span class="mord mathrm mtight">k</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> as measured, e.g., by <a href="https://www.researchgate.net/publication/51992086_Memory_bandwidth_and_machine_balance_in_high_performance_computers">McCalpin, 1995</a> for CPUs or a GPU analogue.</p> <p>Defining the <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{eff}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> metric, we assume that</p> <ol> <li><p>we evaluate an iterative stencil-based solver,</p> <li><p>the problem size is much larger than the cache sizes and</p> <li><p>the usage of time blocking is not feasible or advantageous &#40;reasonable for real-world applications&#41;.</p> </ol> <div class=note ><div class=title >💡 Note</div> <div class=messg >Fields within the effective memory access that do not depend on their own history; such fields can be re-computed on the fly or stored on-chip.</div></div> <p>As first task, we&#39;ll compute the <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{eff}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> for the 2D diffusion code <a href="https://github.com/eth-vaw-glaciology/course-101-0250-00/blob/main/scripts/"><code>diffusion_2D.jl</code></a> we are already familiar with &#40;download the script if needed to get started&#41;.</p> <p>We&#39;ll have to:</p> <ul> <li><p>copy <code>diffusion_2D.jl</code> and rename it to <code>diffusion_2D_Teff.jl</code></p> <li><p>add a timer</p> <li><p>include the performance metric formulas</p> <li><p>deactivate visualisation</p> </ul> <p>💻 Let&#39;s get started</p> <h3 id=timer_and_performance ><a href="#timer_and_performance" class=header-anchor >Timer and performance</a></h3> <ul> <li><p>Use <code>Base.time&#40;&#41;</code> to return the current timestamp</p> <li><p>Define <code>t_tic</code>, the starting time, after 11 time steps to allow for &quot;warmup&quot;</p> <li><p>Record the exact number of iterations &#40;introduce e.g. <code>niter</code>&#41;</p> <li><p>Compute the elapsed time <code>t_toc</code> at the end of the time loop and report:</p> </ul> <pre><code class="julia hljs">t_toc = ...
A_eff = ...          <span class=hljs-comment ># Effective main memory access per iteration [GB]</span>
t_it  = ...          <span class=hljs-comment ># Execution time per iteration [s]</span>
T_eff = A_eff/t_it   <span class=hljs-comment ># Effective memory throughput [GB/s]</span></code></pre> <ul> <li><p>Report <code>t_toc</code>, <code>T_Eff</code> and <code>niter</code> at the end of the code, formatting output using <code>@printf&#40;&#41;</code> macro.</p> <li><p>Round <code>T_eff</code> to the 3rd significant digit.</p> </ul> <pre><code class="julia hljs"><span class=hljs-meta >@printf</span>(<span class=hljs-string >&quot;Time = %1.3f sec, ... \n&quot;</span>, t_toc, ...)</code></pre>
<h3 id=deactivate_visualisation ><a href="#deactivate_visualisation" class=header-anchor >Deactivate visualisation</a></h3>
<ul>
<li><p>Use keyword arguments &#40;&quot;kwargs&quot;&#41; to allow for default behaviour</p>

<li><p>Define a <code>do_visu</code> flag set to <code>false</code></p>

</ul>
<pre><code class="julia hljs"><span class=hljs-meta >@views</span> <span class=hljs-keyword >function</span> diffusion_2D(; ??)

   ...

    <span class=hljs-keyword >return</span>
<span class=hljs-keyword >end</span>

diffusion_2D(; ??)</code></pre>
<p>So far so good, we have now a timer.</p>
<p>Let&#39;s also boost resolution to <code>nx &#61; ny &#61; 512</code> and set <code>ttot &#61; 0.1</code> to have the code running ~1 sec.</p>
<p>In the next part, we&#39;ll work on a multi-threading implementation.</p>
<h2 id=parallel_computing_on_cpus ><a href="#parallel_computing_on_cpus" class=header-anchor >Parallel computing on CPUs</a></h2>
<p><em>Towards implementing shared memory parallelisation using multi-threading capabilities of modern multi-core CPUs.</em></p>
<p>We&#39;ll work it out in 4 steps:</p>
<ol>
<li><p>Precomputing scalars, removing divisions and casual arrays</p>

<li><p>Replacing flux arrays by macros</p>

<li><p>Back to loops I</p>

<li><p>Back to loops II - compute functions &#40;kernels&#41;</p>

</ol>
<h3 id=precomputing_scalars_removing_divisions_and_casual_arrays ><a href="#precomputing_scalars_removing_divisions_and_casual_arrays" class=header-anchor ><ol>
<li><p>Precomputing scalars, removing divisions and casual arrays</p>

</ol>
</a></h3>
<p>As first, duplicate <code>diffusion_2D_Teff.jl</code> and rename it as <code>diffusion_2D_perf.jl</code></p>
<ul>
<li><p>First, replace <code>D/dx</code> and <code>D/dy</code> in the flux calculations by precomputed <code>D_dx &#61; D/dx</code> and <code>D_dy &#61; D/dy</code> in the fluxes.</p>

<li><p>Then, replace divisions <code>/dx, /dy</code> by inverse multiplications <code>*_dx, *_dy</code> where <code>_dx, _dy &#61; 1.0/dx, 1.0/dy</code>.</p>

<li><p>Remove the <code>dCdt</code> array as we do not actually need it in the algorithm.</p>

</ul>
<h3 id=ol_start2_replacing_flux_arrays_by_macros ><a href="#ol_start2_replacing_flux_arrays_by_macros" class=header-anchor ><ol start=2 >
<li><p>Replacing flux arrays by macros</p>

</ol>
</a></h3>
<p>As first, duplicate <code>diffusion_2D_perf.jl</code> and rename it as <code>diffusion_2D_perf2.jl</code></p>
<p>Storing flux calculations in <code>qx</code> and <code>qy</code> arrays is not needed and produces additional read/write we want to avoid.</p>
<p>Let&#39;s create macros and call them in the time loop:</p>
<pre><code class="julia hljs"><span class=hljs-keyword >macro</span> qx()  esc(:( ... )) <span class=hljs-keyword >end</span>
<span class=hljs-keyword >macro</span> qy()  esc(:( ... )) <span class=hljs-keyword >end</span></code></pre>
<p>Macro will be expanded at preprocessing stage &#40;copy-paste&#41;</p>
<p>Advantages of using macros vs functions:</p>
<ul>
<li><p>easier syntax &#40;no need to specify indices&#41;</p>

<li><p>there can be a performance advantage &#40;if functions are not inlined&#41;</p>

</ul>
<p>Also, we now have to ensure <code>C</code> is not read and written back in the same &#40;will become important when enabling multi-threading&#41;.</p>
<p>Define <code>C2</code>, a copy of <code>C</code>, modify the physics computation line, and implement a pointer swap</p>
<pre><code class="julia hljs">C2      = ...
<span class=hljs-comment ># [...]</span>
C2[<span class=hljs-number >2</span>:<span class=hljs-keyword >end</span>-<span class=hljs-number >1</span>,<span class=hljs-number >2</span>:<span class=hljs-keyword >end</span>-<span class=hljs-number >1</span>] .= C[<span class=hljs-number >2</span>:<span class=hljs-keyword >end</span>-<span class=hljs-number >1</span>,<span class=hljs-number >2</span>:<span class=hljs-keyword >end</span>-<span class=hljs-number >1</span>] .- dt.*( ... )
C, C2 = ... <span class=hljs-comment ># pointer swap</span></code></pre>
<h3 id=ol_start3_back_to_loops_i ><a href="#ol_start3_back_to_loops_i" class=header-anchor ><ol start=3 >
<li><p>Back to loops I</p>

</ol>
</a></h3>
<p>As first, duplicate <code>diffusion_2D_perf2.jl</code> and rename it as <code>diffusion_2D_perf_loop.jl</code></p>
<p>The goal is now to write out the diffusion physics in a loop fashion over <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span> dimensions.</p>
<p>Implement a nested loop, taking car of bounds and staggering.</p>
<pre><code class="julia hljs"><span class=hljs-keyword >for</span> iy=<span class=hljs-number >1</span>:??
    <span class=hljs-keyword >for</span> ix=<span class=hljs-number >1</span>:??
        C2[??] = C[??] - dt*( (<span class=hljs-meta >@qx</span>(ix+<span class=hljs-number >1</span>,iy) - <span class=hljs-meta >@qx</span>(ix,iy))*_dx + (<span class=hljs-meta >@qy</span>(ix,iy+<span class=hljs-number >1</span>) - <span class=hljs-meta >@qy</span>(ix,iy))*_dy )
    <span class=hljs-keyword >end</span>
<span class=hljs-keyword >end</span></code></pre>
<p>Note that macros can take arguments, here <code>ix,iy</code>, and need updated definition.</p>
<p>Macro argument can be used in definition appending <code>&#36;</code>.</p>
<pre><code class="julia hljs"><span class=hljs-keyword >macro</span> qx(ix,iy)  esc(:( ... C[$ix+<span class=hljs-number >1</span>,$iy+<span class=hljs-number >1</span>] ... )) <span class=hljs-keyword >end</span>
<span class=hljs-keyword >macro</span> qy(ix,iy)  ...</code></pre>
<p>Performance is already quite better with the loop version. Reasons are that <code>diff&#40;&#41;</code> are allocating tmp and that Julia is overall well optimised for executing loops.</p>
<p>Let&#39;s now implement the final step.</p>
<h3 id=ol_start4_back_to_loops_ii ><a href="#ol_start4_back_to_loops_ii" class=header-anchor ><ol start=4 >
<li><p>Back to loops II</p>

</ol>
</a></h3>
<p>Duplicate <code>diffusion_2D_perf2_loop.jl</code> and rename it as <code>diffusion_2D_perf_loop_fun.jl</code></p>
<p>In this last step, the goal is to define a <code>compute</code> function to hold the physics calculations, and to call it within the time loop.</p>
<p>Create a <code>compute&#33;&#40;&#41;</code> function that takes input and output arrays and needed scalars as argument and returns nothing.</p>
<pre><code class="julia hljs"><span class=hljs-keyword >function</span> compute!(...)
    ...
    <span class=hljs-keyword >return</span>
<span class=hljs-keyword >end</span></code></pre>
<div class=note ><div class=title >💡 Note</div>
<div class=messg >Function that modify arguments take a <code>&#33;</code> in their name, a Julia convention.</div></div>
<p>The <code>compute&#33;&#40;&#41;</code> function can then be called within the time loop</p>
<pre><code class="julia hljs">compute!(...)</code></pre>
<p>This last implementation executes a bit faster as previous one, as functions allow Julia to further optimise during just-ahead-of-time compilation.</p>
<p>Let&#39;s now see how to implement multi-threading and advanced vector instructions &#40;AVX&#41;</p>
<h3 id=multi-threading_native ><a href="#multi-threading_native" class=header-anchor >Multi-threading &#40;native&#41;</a></h3>
<p>Julia ships with it&#39;s <code>base</code> feature the possibility to enable <a href="https://docs.julialang.org/en/v1/manual/multi-threading/">multi-threading</a>.</p>
<p>The only 2 modifications needed to enable it in our code are:</p>
<ol>
<li><p>Place <code>Threads.@threads</code> in front of the outer loop definition</p>

<li><p>Export the desired amount of threads, e.g., <code>export JULIA_NUM_THREADS&#61;4</code>, to be activate prior to launching Julia &#40;or executing the script from the shell&#41;</p>

</ol>
<div class=note ><div class=title >💡 Note</div>
<div class=messg >For optimal performance, the numbers of threads should be identical to the  number of physical cores of the target CPU.</div></div>
<h3 id=multi-threading_and_avx ><a href="#multi-threading_and_avx" class=header-anchor >Multi-threading and AVX</a></h3>
<p>Relying on Julia&#39;s <a href="https://github.com/JuliaSIMD/LoopVectorization.jl">LoopVectorization.jl</a> package, it is possible to combine multi-threading with AVX optimisations to further exploit shared memory parallelisation capabilities of x86 type of CPUs.</p>
<p>To enable it in our code:</p>
<ol>
<li><p>Add <code>using LoopVectorization</code> at the top of the script</p>

<li><p>Replace <code>Threads.@threads</code> by <code>@tturbo</code> in front of the outer loop in the <code>compute&#33;&#40;&#41;</code> kernel</p>

</ol>
<p>And here we go 🚀</p>
<div class=note ><div class=title >💡 Note</div>
<div class=messg >For optimal performance assessment, bound-checking should be deactivated. This can be achieved by adding <code>@inbounds</code> in front of the compute statement, or running the scripts &#40;or launching Julia&#41; with the <code>--check-bounds&#61;no</code> option.</div></div>
<h3 id=wrapping-up ><a href="#wrapping-up" class=header-anchor >Wrapping-up</a></h3>
<ul>
<li><p>We discussed main performance limiters</p>

<li><p>We implemented the effective memory throughput metric <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >e</mi><mi mathvariant=normal >f</mi><mi mathvariant=normal >f</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{eff}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></p>

<li><p>We optimised the Julia 2D diffusion code &#40;multi-threading and AVX&#41;</p>

</ul>
<p>Note that for problem sizes fitting in the cache, <a href="https://github.com/JuliaSIMD/LoopVectorization.jl">LoopVectorization.jl</a>&#39;s <code>@tturbo</code> permits to achieve effective memory throughput close to memory copy rates &#40;<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi mathvariant=normal >p</mi><mi mathvariant=normal >e</mi><mi mathvariant=normal >a</mi><mi mathvariant=normal >k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_\mathrm{peak}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.969438em;vertical-align:-0.286108em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">p</span><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight">a</span><span class="mord mathrm mtight">k</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>&#41;.</p>

<p><a href="#content">⤴ <em><strong>back to Content</strong></em></a></p>
<h1 id=unit_testing_in_julia ><a href="#unit_testing_in_julia" class=header-anchor >Unit testing in Julia</a></h1>
<h3 id=the_julia_test_module ><a href="#the_julia_test_module" class=header-anchor >The Julia <code>Test</code> module</a></h3>
<p><a href="https://docs.julialang.org/en/v1/stdlib/Test/#Basic-Unit-Tests">Basic unit tests</a> in Julia</p>
<ul>
<li><p>Provides simple <em>unit testing</em> functionality</p>

<li><p>A way to assess if code is correct by checking that results are as expected</p>

<li><p>Helpful to ensure the code still works after changes</p>

<li><p>Can be used when developing</p>

<li><p>Should be used in package for CI</p>

</ul>
<h2 id=basic_unit_tests ><a href="#basic_unit_tests" class=header-anchor >Basic unit tests</a></h2>
<p>Simple unit testing can be performed with the <code>@test</code> and <code>@test_throws</code> macros:</p>
<pre><code class="julia hljs"><span class=hljs-keyword >using</span> Test

<span class=hljs-meta >@test</span> <span class=hljs-literal >true</span></code></pre>
<p>Or another example</p>
<pre><code class="julia hljs"><span class=hljs-meta >@test</span> [<span class=hljs-number >1</span>, <span class=hljs-number >2</span>] + [<span class=hljs-number >2</span>, <span class=hljs-number >1</span>] == [<span class=hljs-number >3</span>, <span class=hljs-number >3</span>]</code></pre>
<p>Testing an expression which is a call using infix syntax such as approximate comparisons</p>
<pre><code class="julia hljs"><span class=hljs-meta >@test</span> <span class=hljs-literal >π</span> ≈ <span class=hljs-number >3.14</span> atol=<span class=hljs-number >0.01</span></code></pre>
<p>For example, suppose we want to check our new function <code>square&#33;&#40;x&#41;</code> works as expected:</p>
<pre><code class="julia hljs">square!(x) = x^<span class=hljs-number >2</span></code></pre>
<p>If the condition is true, a <code>Pass</code> is returned:</p>
<pre><code class="julia hljs"><span class=hljs-meta >@test</span> square!(<span class=hljs-number >5</span>) == <span class=hljs-number >25</span></code></pre>
<p>If the condition is false, then a <code>Fail</code> is returned and an exception is thrown:</p>
<pre><code class="julia hljs"><span class=hljs-meta >@test</span> square!(<span class=hljs-number >5</span>) == <span class=hljs-number >20</span></code></pre>
<h2 id=working_with_a_test_sets ><a href="#working_with_a_test_sets" class=header-anchor >Working with a test sets</a></h2>
<p>The <code>@testset</code> macro can be used to group <a href="https://docs.julialang.org/en/v1/stdlib/Test/#Working-with-Test-Sets">tests into sets</a>.</p>
<p>All the tests in a test set will be run, and at the end of the test set a summary will be printed.</p>
<p>If any of the tests failed, or could not be evaluated due to an error, the test set will then throw a <code>TestSetException</code>.</p>
<pre><code class="julia hljs"><span class=hljs-meta >@testset</span> <span class=hljs-string >&quot;trigonometric identities&quot;</span> <span class=hljs-keyword >begin</span>
    θ = <span class=hljs-number >2</span>/<span class=hljs-number >3</span>*<span class=hljs-literal >π</span>
    <span class=hljs-meta >@test</span> sin(-θ) ≈ -sin(θ)
    <span class=hljs-meta >@test</span> cos(-θ) ≈ cos(θ)
    <span class=hljs-meta >@test</span> sin(<span class=hljs-number >2</span>θ) ≈ <span class=hljs-number >2</span>*sin(θ)*cos(θ)
    <span class=hljs-meta >@test</span> cos(<span class=hljs-number >2</span>θ) ≈ cos(θ)^<span class=hljs-number >2</span> - sin(θ)^<span class=hljs-number >2</span>
<span class=hljs-keyword >end</span>;</code></pre>
<p>Let&#39;s try it with our <code>square&#33;&#40;&#41;</code> function</p>
<pre><code class="julia hljs">square!(x) = x^<span class=hljs-number >2</span>

<span class=hljs-meta >@testset</span> <span class=hljs-string >&quot;Square Tests&quot;</span> <span class=hljs-keyword >begin</span>
    <span class=hljs-meta >@test</span> square!(<span class=hljs-number >5</span>) == <span class=hljs-number >25</span>
    <span class=hljs-meta >@test</span> square!(<span class=hljs-string >&quot;a&quot;</span>) == <span class=hljs-string >&quot;aa&quot;</span>
    <span class=hljs-meta >@test</span> square!(<span class=hljs-string >&quot;bb&quot;</span>) == <span class=hljs-string >&quot;bbbb&quot;</span>
<span class=hljs-keyword >end</span>;</code></pre>
<p>If we now introduce a bug</p>
<pre><code class="julia hljs">square!(x) = x^<span class=hljs-number >2</span>

<span class=hljs-meta >@testset</span> <span class=hljs-string >&quot;Square Tests&quot;</span> <span class=hljs-keyword >begin</span>
    <span class=hljs-meta >@test</span> square!(<span class=hljs-number >5</span>) == <span class=hljs-number >25</span>
    <span class=hljs-meta >@test</span> square!(<span class=hljs-string >&quot;a&quot;</span>) == <span class=hljs-string >&quot;aa&quot;</span>
    <span class=hljs-meta >@test</span> square!(<span class=hljs-string >&quot;bb&quot;</span>) == <span class=hljs-string >&quot;bbbb&quot;</span>
    <span class=hljs-meta >@test</span> square!(<span class=hljs-number >5</span>) == <span class=hljs-number >20</span>
<span class=hljs-keyword >end</span>;</code></pre>
<p>Then then the reporting tells us a test failed.</p>
<h3 id=wrapping-up__2 ><a href="#wrapping-up__2" class=header-anchor >Wrapping-up</a></h3>
<ul>
<li><p>The <code>Test</code> module provides simple <em>unit testing</em> functionality</p>

<li><p>Tests can be grouped into sets using <code>@testset</code></p>

<li><p>We&#39;ll later see how tests can be used in CI</p>

</ul>

<p><a href="#content">⤴ <em><strong>back to Content</strong></em></a></p>
<h1 id=exercises_-_lecture_5 ><a href="#exercises_-_lecture_5" class=header-anchor >Exercises - lecture 5</a></h1>
<div class=warning ><div class=title >⚠️ Warning&#33;</div>
<div class=messg >Exercises have to be handed in as monolithic Julia scripts &#40;one code per script&#41; and uploaded to your private &#40;shared&#41; GitHub repository, in a <strong>specific folder for each lecture</strong>. The git commit hash &#40;or SHA&#41; of the final push needs to be uploaded on Moodle &#40;<a href="/course-101-0250-00/homework">more</a>&#41;.</div></div>
<div class=page-foot >
  <div class=copyright >
    <a href="https://github.com/eth-vaw-glaciology/course-101-0250-00/"><b>Edit this page on <img class=github-logo  src="https://unpkg.com/ionicons@5.1.2/dist/svg/logo-github.svg"></b></a><br>
    Last modified: October 18, 2021. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>.
  </div>
</div>
</div>
    </div>