<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <script src="/libs/lunr/lunr.min.js"></script> <script src="/libs/lunr/lunr_index.js"></script> <script src="/libs/lunr/lunrclient.min.js"></script> <link rel=stylesheet  href="/libs/katex/katex.min.css"> <link rel=stylesheet  href="/libs/highlight/github.min.css"> <link rel=stylesheet  href="/css/franklin.css"> <link rel=stylesheet  href="/css/poole_hyde.css"> <link rel=stylesheet  href="/css/custom.css"> <style> html {font-size: 17px;} .franklin-content {position: relative; padding-left: 8%; padding-right: 5%; line-height: 1.35em;} @media (min-width: 940px) { .franklin-content {width: 100%; margin-left: auto; margin-right: auto;} } @media (max-width: 768px) { .franklin-content {padding-left: 6%; padding-right: 6%;} } </style> <link rel=icon  href="/assets/favicon.png"> <title>Lecture 4</title> <style> .content {max-width: 50rem} </style> <div class=sidebar > <div class="container sidebar-sticky"> <div class=sidebar-about > <img src="/assets/vaw_logo.png" style="width: 180px; height: auto; display: inline"> <div style="font-weight: margin-bottom: 0.5em"><a href="/"> Fall 2022</a> <span style="opacity: 0.7;">| <a href="http://www.vvz.ethz.ch/Vorlesungsverzeichnis/lerneinheit.view?semkez=2022W&ansicht=KATALOGDATEN&lerneinheitId=162403&lang=en"> ETHZ 101-0250-00</a></span></div> <br> <h1><a href="/">Solving partial differential equations in parallel on GPUs</a></h1> <div style="line-height:18px; font-size: 15px; opacity: 0.85">by &nbsp; <a href="https://vaw.ethz.ch/en/people/person-detail.MjcwOTYw.TGlzdC8xOTYxLDE1MTczNjI1ODA=.html">Ludovic Räss</a>, &nbsp; <a href="https://vaw.ethz.ch/en/personen/person-detail.html?persid=124402">Mauro Werder</a>, &nbsp; <a href="https://www.cscs.ch/about/staff/">Samuel Omlin</a> & <br> <a href="https://vaw.ethz.ch/en/people/person-detail.MzAwMjIy.TGlzdC8xOTYxLDE1MTczNjI1ODA=.html">Ivan Utkin</a> </div> </div> <br> <style> </style> <nav class=sidebar-nav  style="opacity: 0.9; margin-bottom: 1.2cm;"> <a class="sidebar-nav-item " href="/"><b>Welcome</b></a> <a class="sidebar-nav-item " href="/logistics/">Logistics</a> <a class="sidebar-nav-item " href="/homework/">Homework</a> <a class="sidebar-nav-item " href="/software_install/">Software install</a> <a class="sidebar-nav-item " href="/extras/">Extras</a> <br> <div class=course-section >Part 1 - Introduction</div> <a class="sidebar-nav-item " href="/lecture1/">Lecture 1 - Why Julia GPU</a> <a class="sidebar-nav-item " href="/lecture2/">Lecture 2 - PDEs & physical processes</a> <a class="sidebar-nav-item " href="/lecture3/">Lecture 3 - Solving elliptic PDEs</a> <div class=course-section >Part 2 - Solving PDEs on GPUs</div> <a class="sidebar-nav-item active" href="/lecture4/">Lecture 4 - Porous convection</a> <a class="sidebar-nav-item " href="/lecture5/">Lecture 5 - Parallel computing</a> <a class="sidebar-nav-item " href="/lecture6/">Lecture 6 - GPU computing & perf</a> <div class=course-section >Part 3 - Multi-GPU computing (projects)</div> <a class="sidebar-nav-item " href="/lecture7/">Lecture 7 - XPU computing</a> <a class="sidebar-nav-item " href="/lecture8/">Lecture 8 - Julia MPI & multi-XPU</a> <a class="sidebar-nav-item " href="/lecture9/">Lecture 9 - Advanced optimisations</a> <div class=course-section >Final Projects</div> <a class="sidebar-nav-item " href="/lecture10/">Lecture 10 - Final projects</a> </nav> <form id=lunrSearchForm  name=lunrSearchForm > <input class=search-input  name=q  placeholder="Enter search term" type=text > <input type=submit  value=Search  formaction="/search/index.html"> </form> <br> <br> </div> </div> <div class="content container"> <div class=franklin-content > <h1 id=lecture_4 ><a href="#lecture_4" class=header-anchor >Lecture 4</a></h1> <blockquote> <p><strong>Agenda</strong><br />📚 Implicit and steady-state solutions<br />💻 Julia&#39;s <code>Project</code> environment<br />🚧 Exercises:</p> <ul> <li><p>Porous convection in 2D</p> <li><p>...</p> </ul> </blockquote> <p><hr /> </p> <p><a id=content  class=anchor ></a> <strong>Content</strong></p> <div class=franklin-toc ><ol><li><a href="#lecture_4">Lecture 4</a><li><a href="#modelling_multi-physics">Modelling multi-physics</a><ol><li><a href="#what_is_convection_and_why_we_want_to_model_it">What is convection and why we want to model it</a><li><a href="#thermal_porous_convection_a_physical_model">Thermal porous convection: a physical model</a><li><a href="#solving_thermal_porous_convection_using_the_pseudo-transient_method">Solving thermal porous convection using the pseudo-transient method</a></ol><li><a href="#julias_project_environment">Julia&#39;s Project environment</a><li><a href="#exercises_-_lecture_4">Exercises - lecture 4</a></ol></div> <p><a href="#exercises_-_lecture_4"><em>👉 get started with exercises</em></a></p> <hr /> <h1 id=modelling_multi-physics ><a href="#modelling_multi-physics" class=header-anchor >Modelling multi-physics</a></h1> <h3 id=the_goal_of_lecture_4_is_to_combine_the_acquired_knowledge_of_numerical_modelling_and_develop_the_first_practical_application_thermal_porous_convection_in_2d ><a href="#the_goal_of_lecture_4_is_to_combine_the_acquired_knowledge_of_numerical_modelling_and_develop_the_first_practical_application_thermal_porous_convection_in_2d" class=header-anchor >The goal of lecture 4 is to combine the acquired knowledge of numerical modelling and develop the first practical application: thermal porous convection in 2D.</a></h3> <h3 id=building_upon ><a href="#building_upon" class=header-anchor >Building upon:</a></h3> <ul> <li><p>The diffusion equation</p> <li><p>Spatial discretisation: 1D and 2D</p> <li><p>Finite-differences and staggered grids</p> <li><p>Accelerated pseudo-transient method</p> </ul> <h2 id=what_is_convection_and_why_we_want_to_model_it ><a href="#what_is_convection_and_why_we_want_to_model_it" class=header-anchor >What is convection and why we want to model it</a></h2> <p>Convection is a fluid flow driven by any instability arising from the interaction between the fluid properties such as density, and external forces such as gravity. If a layer of denser fluid lays on top of a layer of fluid with lower density, they will eventually mix and swap. An example of such fluids would be oil and water. In thermal convection, the density difference is caused by the thermal expansion of the fluid, i.e., the dependence of density on temperature. Usually, higher temperatures correspond to the lower densities.</p> <center> <video width="80%" autoplay loop controls src="https://upload.wikimedia.org/wikipedia/commons/0/0e/Lava_lamp_%28oT%29_07_ies.ogv"/> </center> <p>Fluid flows in porous materials such as rocks and soil could also be a result of convection. In this course, we only consider porous convection since it build on the already acquired knowledge of steady-state and transient diffusion processes. Porous convection often arises in nature and geoengineering. For example, water circulation in hydrothermal systems is caused by thermal convection, and mixing of CO\(_2\) with saline water during geological storage results from chemical convection.</p> <p>In the following, we will introduce the equation governing the thermal porous convection, demonstrate that in the simple cases these equations reduce to the already familiar steady-state and transient diffusion equations.</p> <h2 id=thermal_porous_convection_a_physical_model ><a href="#thermal_porous_convection_a_physical_model" class=header-anchor >Thermal porous convection: a physical model</a></h2> <p>Consider a layer of porous material of size \(l_x \times l_y\). We assume that this layer is saturated with fluid, i.e., the pore space is completely filled by fluid. We introduce the <em>porosity</em> \(\varphi\) – the volume fraction of material taken by pore space. The conservation of mass for the fluid requires:</p> \[ \frac{\partial\varphi\rho}{\partial t} + \nabla\cdot(\rho\varphi\boldsymbol{v}) = 0 \] <p>Here \(\rho\) is the density of the fluid, and \(\boldsymbol{v}\) is the fluid velocity. If the porous material is undeformable, i.e. \(\varphi = \mathrm{const}\) and the fluid is incompressible, i.e., \(\mathrm{d}\rho/\mathrm{d}t = \partial\rho/\partial t + \boldsymbol{v}\cdot\nabla\rho = 0\), the conservation of mass reduces to the following:</p> \[ \nabla\cdot(\varphi\boldsymbol{v}) = 0 \] <h3 id=darcys_law ><a href="#darcys_law" class=header-anchor >Darcy&#39;s law</a></h3> <p>We define the quantity \(\boldsymbol{q_D} = \varphi\boldsymbol{v}\), which is called the <em>Darcy flux</em> or <em>Darcy velocity</em> and is the volumetric flow rate per unit area of the porous media. Standard approximation is the linear dependence between \(\boldsymbol{q_D}\) and the pressure gradient, known as the <a href="https://en.wikipedia.org/wiki/Darcy&#39;s_law"><em>Darcy&#39;s law</em></a>:</p> \[ \boldsymbol{q_D} = -\frac{k}{\eta}(\nabla p - \rho \boldsymbol{g}) \] <p>where \(k\) is the proportionality coefficient called <em>permeability</em>, \(\eta\) is the fluid viscosity, \(p\) is pressure, \(\boldsymbol{g}\) is the gravity vector.</p> <h3 id=diffusion_equation_for_pressure ><a href="#diffusion_equation_for_pressure" class=header-anchor >Diffusion equation for pressure</a></h3> <p>Substituting the Darcy&#39;s law into the mass conservation law for incompressible fluid, we obtain the steady-state diffusion equation for the pressure \(p\):</p> \[ -\nabla\cdot\left[\frac{k}{\eta}(\nabla p - \rho\boldsymbol{g})\right] = 0 \] <h3 id=heat_convection_in_porous_media ><a href="#heat_convection_in_porous_media" class=header-anchor >Heat convection in porous media</a></h3> <p>In the following, we assume for simplicity that the porosity is constant: \(\varphi=\mathrm{const}\).</p> <p>Conservation of energy in the fluid results in the following equation for the temperature \(T\):</p> \[ \rho c_p \frac{\partial T}{\partial t} + \rho c_p\boldsymbol{v}\cdot\nabla T + \nabla\cdot\boldsymbol{q_T} = 0 \] <p>Here, \(c_p\) is the specific heat capacity of the fluid, and \(\boldsymbol{q_T}\) is the conductive heat flux. Note that the time \(t\) here is the physical time.</p> <p>In a very similar manner to the Darcy&#39;s law, we relate the heat flux to the gradient of temperature &#40;Fourier&#39;s law&#41;:</p> \[ \boldsymbol{q_T} = -\lambda\nabla T \] <p>where \(\lambda\) is the <em>thermal conductivity</em>. Assuming \(\lambda=\mathrm{const}\), substituting the Fourier&#39;s law into the energy equation, and using the definition of the Darcy flux we obtain:</p> \[ \frac{\partial T}{\partial t} + \frac{1}{\varphi}\boldsymbol{q_D}\cdot\nabla T - \frac{\lambda}{\rho c_p} \nabla\cdot\nabla T = 0 \] <p>This is the transient advection-diffusion equation. The temperature is advected with the fluid velocity \(\boldsymbol{q_D}/\varphi\) and diffused with the diffusion coefficient \(\lambda/(\rho c_p)\)</p> <h3 id=modeling_buoyancy_boussinesq_approximaiton ><a href="#modeling_buoyancy_boussinesq_approximaiton" class=header-anchor >Modeling buoyancy: Boussinesq approximaiton</a></h3> <p>Now the transient pressure diffusion and steady pressure diffusion are coupled in a one-way fashion through the Darcy flux in the temperature equation. To model convection, we need to incorporate the dependency of the density on temperature in the equations. The simplest way is to introduce the linear dependency:</p> \[ \rho = \rho_0\left\[1-\alpha (T-T_0)\right\] \] <p>where \(\alpha\) is the thermal expansion coefficient.</p> <p>However, the equations were formulated for the incompressible case&#33;</p> <p>In convection problems, the gravity term \(\rho\boldsymbol{g}\) makes the dominant contribution to the force balance. Therefore, variations in density due to thermal expansion are often accounted for only in the \(\rho\boldsymbol{g}\) term and are neglected in other places. This is called the <a href="https://en.wikipedia.org/wiki/Boussinesq_approximation_&#40;buoyancy&#41;"><em>Boussinesq approximation</em></a>.</p> <p>Using the Boussinesq approximation, the incompressible equations remain valid, and the only place where the modified densities is the definition of the Darcy flux:</p> \[ \boldsymbol{q_D} = -\frac{k}{\eta}(\nabla P - \rho_0\left[1-\alpha (T-T_0)\right]\boldsymbol{g}) \] <h2 id=solving_thermal_porous_convection_using_the_pseudo-transient_method ><a href="#solving_thermal_porous_convection_using_the_pseudo-transient_method" class=header-anchor >Solving thermal porous convection using the pseudo-transient method</a></h2> <p>We already discussed how the steady-state and transient equations could be solved efficiently by adding the pseudo-transient terms to the governing equations. Let&#39;s do this for the porous convection&#33;</p> <p>But let&#39;s first look at the equation, augmenting the Table we just started to fill</p> <table><tr><th align=center >Physics<th align=center >1D formulation<th align=center >2D formulation<tr><td align=center >Diffusion<td align=center >\(q_x = -D\frac{∂C}{∂x}\)<td align=center >\(q_x = -D\frac{∂C}{∂x}\)<tr><td align=center ><td align=center ><td align=center >\(q_y = -D\frac{∂C}{∂y}\)<tr><td align=center ><td align=center >\(\frac{∂C}{∂t} = -\frac{∂q_x}{∂x}\)<td align=center >\(\frac{∂C}{∂t} = -\left(\frac{∂q_x}{∂x} + \frac{∂q_y}{∂y} \right)\)<tr><td align=center >Acoustic waves<td align=center >\(\frac{∂V_x}{∂t} = -\frac{1}{ρ}~\frac{∂P}{∂x}\)<td align=center >\(\frac{∂V_x}{∂t} = -\frac{1}{ρ}~\frac{∂P}{∂x}\)<tr><td align=center ><td align=center ><td align=center >\(\frac{∂V_y}{∂t} = -\frac{1}{ρ}~\frac{∂P}{∂y}\)<tr><td align=center ><td align=center >\(\frac{∂P}{∂t} = -K~\frac{∂V_x}{∂x}\)<td align=center >\(\frac{∂P}{∂t} = -K~\left(\frac{∂V_x}{∂x} + \frac{∂V_y}{∂y} \right)\)</table> <h4 id=initialise_arrays ><a href="#initialise_arrays" class=header-anchor >Initialise arrays</a></h4> <p>Recall that we are using conservative finite-differences and thus a <em>staggered grid</em>.</p> <p>For 2D grids, we will have to handle scalar quantity and two fluxes as depicted below, taking care about correct staggering:</p> <p><img src="../assets/literate_figures/l4_stagg_2D.png" alt=staggered-grid  /></p> <h4 id=2d_plotting ><a href="#2d_plotting" class=header-anchor >2D plotting</a></h4> <p>You can use <code>heatmap&#40;&#41;</code> function from <code>Plots.jl</code>, to plot e.g. <code>C</code> as function of the spatial coordinates <code>xc</code> and <code>yc</code>:</p> <pre><code class=language-julia >heatmap&#40;xc, yc, C&#39;&#41;</code></pre>
<p><em>note the transpose <code>&#39;</code></em></p>
<p>Use <code>display&#40;&#41;</code> to force the display of the plot, e.g., in the time loop every <code>nout</code>.</p>
<p>More advanced implementation, one can define the plotting options and apply them in the <code>heatmap&#40;&#41;</code> call:</p>
<pre><code class=language-julia >opts &#61; &#40;aspect_ratio&#61;1, xlims&#61;&#40;xc&#91;1&#93;, xc&#91;end&#93;&#41;, ylims&#61;&#40;yc&#91;1&#93;, yc&#91;end&#93;&#41;, clims&#61;&#40;0.0, 1.0&#41;, c&#61;:davos, xlabel&#61;&quot;Lx&quot;, ylabel&#61;&quot;Ly&quot;, title&#61;&quot;time &#61; &#36;&#40;round&#40;it*dt, sigdigits&#61;3&#41;&#41;&quot;&#41;
display&#40;heatmap&#40;xc, yc, C&#39;; opts...&#41;&#41;</code></pre>
<p>Let&#39;s get started with 2D.</p>
<p><strong>It&#39;s time to launch Julia on your computer</strong> 🚀</p>
<p>👉 <a href="https://github.com/eth-vaw-glaciology/course-101-0250-00/blob/main/scripts/">Download the <code>diffusion_1D.jl</code> script</a> to get you started</p>
<h1 id=julias_project_environment ><a href="#julias_project_environment" class=header-anchor >Julia&#39;s Project environment</a></h1>
<p>On GitHub, make sure to create a new folder for each week&#39;s exercises.</p>
<p>Each week&#39;s folder should be a Julia project, i.e. contain a <code>Project.toml</code> file.</p>
<p>This can be achieved by typing entering the Pkg mode from the Julia REPL in the target folder</p>
<pre><code class=language-julia-repl >julia&gt; &#93;

&#40;@v1.8&#41; pkg&gt; activate .

&#40;lectureXX&#41; pkg&gt; add Plots</code></pre>
<p>and adding at least one package.</p>
<p>In addition, it is recommended to have the following structure and content:</p>
<ul>
<li><p>lectureXX</p>
<ul>
<li><p><code>README.md</code></p>

<li><p><code>Project.toml</code></p>

<li><p><code>Manifest.toml</code></p>

<li><p>docs/</p>

<li><p>scripts/</p>

</ul>

</ul>
<p>Codes could be placed in the <code>scripts/</code> folder. Output material to be displayed in the <code>README.md</code> could be placed in the <code>docs/</code> folder.</p>
<div class=note ><div class=title >💡 Note</div>
<div class=messg >The <code>Manifest.toml</code> file should be kept local. An automated way of doing so is to add it as entry to a <code>.gitignore</code> file in the root of your repo. Mac users may also add <code>.DS_Store</code> to their <code>.gitignore</code></div></div>

<p><a href="#content">⤴ <em><strong>back to Content</strong></em></a></p>
<h1 id=exercises_-_lecture_4 ><a href="#exercises_-_lecture_4" class=header-anchor >Exercises - lecture 4</a></h1>
<div class=warning ><div class=title >⚠️ Warning&#33;</div>
<div class=messg >Exercises have to be handed in as monolithic Julia scripts &#40;one code per script&#41; and uploaded to your private &#40;shared&#41; GitHub repository, in a <strong>specific folder for each lecture</strong>. The git commit hash &#40;or SHA&#41; of the final push needs to be uploaded on Moodle &#40;<a href="/homework">more</a>&#41;.</div></div>
<div class=page-foot >
  <div class=copyright >
    <a href="https://github.com/eth-vaw-glaciology/course-101-0250-00/"><b>Edit this page on <img class=github-logo  src="https://unpkg.com/ionicons@5.1.2/dist/svg/logo-github.svg"></b></a><br>
    Last modified: October 10, 2022. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>.
  </div>
</div>
</div>
    </div>  
    
        <script src="/libs/katex/katex.min.js"></script>
<script src="/libs/katex/auto-render.min.js"></script>
<script>renderMathInElement(document.body)</script>

    
    
        <script src="/libs/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();hljs.configure({tabReplace: '    '});</script>